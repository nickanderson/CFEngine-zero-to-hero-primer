<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>CFEngine Zero to Hero Primer</title>
<meta name="author" content="Nick Anderson"/>
<style type="text/css">
.underline { text-decoration: underline; }
</style>
<link rel="stylesheet" href="./reveal.js/css/reveal.css"/>

<link rel="stylesheet" href="./reveal.js/css/theme/white.css" id="theme"/>


<!-- If the query includes 'print-pdf', include the PDF print sheet -->
<script>
    if( window.location.search.match( /print-pdf/gi ) ) {
        var link = document.createElement( 'link' );
        link.rel = 'stylesheet';
        link.type = 'text/css';
        link.href = './reveal.js/css/print/pdf.css';
        document.getElementsByTagName( 'head' )[0].appendChild( link );
    }
</script>
<meta name=description" content=CFEngine Zero to Hero Primer.">
</head>
<body>
<div class="reveal">
<div class="slides">
<section id="sec-title-slide">
<h1 class="title">CFEngine Zero to Hero Primer</h1><h2 class="author">Nick Anderson</h2>
</section>

<section>
<section id="slide-orgdd1b013">
<h2 id="orgdd1b013">Introduction</h2>
<p>
<b>CFEngine</b> contains a powerful language for controlling all aspects of a system.
CFEngine runs primarily on UNIX and UNIX-like operating systems, but can also
run on Windows.
</p>

<p>
Goal for this presentation: Learn <b>20%</b> of CFEngine enabling <b>80%</b> of your work.
</p>

</section>
<section id="slide-org939ed40">
<h3 id="org939ed40">Why CFEngine?</h3>
<ul>
<li>Mature</li>
<li>Small</li>
<li>Fast</li>
<li>Flexible</li>
<li>Portable</li>

</ul>

<aside class="notes">
<dl>
<dt>Mature</dt><dd>Originally released in 1993 (same year as Linux)</dd>
<dt>Small/Fast</dt><dd>proliferation of <i>physical</i> devices, you know your containers
are still running on some host, and that host needs to be in
compliance. Security issues in hardware, mitigation can
degrade performance &gt;10%</dd>
<dt>Flexible/Portable</dt><dd>Servers, workstations, IoT</dd>

</dl>

</aside>

</section>
<section id="slide-orgf979c91">
<h3 id="orgf979c91">Want to know more?</h3>
<ul>
<li><a href="http://verticalsysadmin.com/">Vertical Sysadmin's CFEngine courses</a></li>
<li><a href="https://docs.cfengine.com/lts/reference.html">CFEngine Reference Manual</a></li>
<li><a href="mailto:contact@cfengine.com">CFEngine Training &amp; Professional Services</a> (Email)</li>
<li><a href="http://shop.oreilly.com/product/110000787.do">Beyond Automation with CFEngine3</a> (Video Training)</li>

</ul>

</section>
<section id="slide-orgd7d9012">
<h3 id="orgd7d9012">Fork Me on Github!</h3>
<p>
This presentation was made with love using org-mode 9.2.4, cfengine 3.12.2, and
reveal.js 3.8.0. You can get a copy of this presentation any time on Github.
</p>

<p>
<a href="http://github.com/nickanderson/CFEngine-zero-to-hero-primer">http://github.com/nickanderson/CFEngine-zero-to-hero-primer</a>
</p>

</section>
</section>
<section>
<section id="slide-org808526a">
<h2 id="org808526a">CFEngine Components</h2>
<p>
These are the major components of CFEngine that you will encounter on a day to
day basis.
</p>

<ul>
<li><code>cf-agent</code></li>
<li><code>cf-execd</code></li>
<li><code>cf-serverd</code></li>
<li><code>cf-monitord</code></li>

</ul>

</section>
<section id="slide-orge64702a">
<h3 id="orge64702a"><code>cf-agent</code></h3>
<p>
<code>cf-agent</code> is the command you will use most often. It is used to run
policy(code) and ensure your system is in the desired state. If you are running
any CFEngine command from the command line, there's a greater than 99% chance
that this is it.
</p>

</section>
<section id="slide-orga174d00">
<h3 id="orga174d00"><code>cf-execd</code></h3>
<p>
<code>cf-execd</code> is a periodic task scheduler. You can think of it like <code>cron</code> with an
understanding of CFEngine classes.
</p>

<p>
By default CFEngine runs and enforces policies every <i>five minutes</i>. <code>cf-execd</code>
is responsible for making that happen.
</p>

</section>
<section id="slide-org31ab559">
<h3 id="org31ab559"><code>cf-serverd</code></h3>
<p>
<code>cf-serverd</code> runs on the CFEngine server, as well as all clients.
</p>

<ul>
<li>On servers it is responsible for serving files to clients.</li>
<li>On clients it accepts <code>cf-runagent</code> requests</li>
<li>In Enterprise it serves reports to queries from <code>cf-hub</code></li>

</ul>

<p>
<code>cf-runagent</code> allows you to request ad-hoc policy runs. I rarely use it.
</p>

</section>
<section id="slide-orgacec0fa">
<h3 id="orgacec0fa"><code>cf-monitord</code></h3>
<p>
<code>cf-monitord</code> monitors various statistics about the running system. This
information is made available in the form of <b>classes</b> and <b>variables</b>.
</p>

<p>
You'll almost never use <code>cf-monitord</code> directly. However the data provided by
<code>cf-monitord</code> is available to <code>cf-agent</code>.
</p>

</section>
</section>
<section>
<section id="slide-org77c373a" data-background="./media/imperative-vs-declarative1_2016-05-11_16-31-47.png" data-background-size="600px">
<h2 id="org77c373a"></h2>
</section>
<section id="slide-orgf466a24">
<h3 id="orgf466a24">Imperative vs. Declarative</h3>
<p>
It is very likely that you have only ever used <b>imperative</b> languages. Examples
of imperative languages include C, Perl, Ruby, Python, shell scripting, etc.
Name a language. It's probably imperative.
</p>

<p>
CFEngine is a <b>declarative</b> language. The CFEngine language is merely a
<i>description</i> of the final state. CFEngine uses <b>convergence</b> to arrive at the
described state.
</p>

</section>
<section id="slide-org4ad8504">
<h4 id="org4ad8504">Declarative Policy vs Imperative Script</h4>
<pre class="example">
bundle agent main           | #!/bin/env/bash
{                           |
  packages:                 | rpm -q openssh-server || yum install openssh-server
                            | yum check-update openssh-server
    "openssh-server"        | if [ $? -eq 100 ]; then # update available
      policy =&gt; "present",  |   yum upgrade openssh-server
      version =&gt; "latest";  | fi 
}
</pre>

</section>
<section id="slide-orgae19271">
<h3 id="orgae19271">Imperative is Sequential</h3>
<p>
Imperative languages execute step by step in <b>sequence</b>.
</p>

<ul>
<li>Goes in order from start to finish.</li>
<li>If interrupted the state is <i>inconsistent</i>.</li>
<li>Subsequent executions <i>typically</i> repeat tasks already done.
<ul>
<li>Potentially causing damage.</li>

</ul></li>

</ul>

<p>
For Example:
</p>
<ul>
<li>Script appends line to file and restarts daemon.</li>
<li>Second execution appends duplicate line and restarts daemon.
<ul>
<li>Daemon doesn't accept duplicate lines and service refuses to run.</li>

</ul></li>

</ul>

<p>
<b>Imperative starts at known state A and transforms to known state B.</b>
</p>

</section>
<section id="slide-orga2720e1">
<h3 id="orga2720e1">Declarative is Descriptive</h3>
<p>
It is not a list of steps to achieve an outcome but a <b>description</b> of the
desired state. Because of this any deviation from the desired state can be
detected and corrected.
</p>

<p>
In other words, a declarative system can begin in <i>any</i> state, not simply a
known state, and transform into the desired state.
</p>

<p>
Declarative states a list of things which must be true. It does not state how to
make them true.
</p>

<p>
When a system has reached the desired state it is said to have reached
<b>convergence</b>.
</p>

</section>
</section>
<section>
<section id="slide-orga27d837">
<h2 id="orga27d837">Promise Theory</h2>
<p>
Promise theory is the <b>fundamental underlying philosophy</b> that drives CFEngine.
</p>

<p>
It is a model of voluntary cooperation between individual, autonomous actors or
agents who publish their intentions to one another in the form of promises.
</p>

</section>
<section id="slide-org343f008">
<h3 id="org343f008">What makes promises?</h3>
<p>
<b>A file</b> (e.g., <code>/etc/apache2/httpd.conf</code>) can make promises about its own
contents, attributes, etc. But it does not make any promises about a process.
</p>

<p>
<b>A process</b> (e.g., <code>httpd</code>) can make a promise that it will be running. But it
does not make any promises about its configuration.
</p>

<p>
The configuration file and the process are <i>autonomous</i>. Each makes promises
about itself which cooperate toward an end.
</p>

</section>
<section id="slide-orgb3aeca9">
<h3 id="orgb3aeca9">Going deeper</h3>
<ul>
<li><a href="https://www.youtube.com/playlist?list=PLYwRmweZvwB1C9HXvT4g6jXfZYET_cgXP">Promise Theory (animated video series)</a>
<ul>
<li><a href="https://www.youtube.com/watch?v=2TPsB5WuZgk&amp;t=145s">Basic concepts</a> (part 1)</li>
<li><a href="https://www.youtube.com/watch?v=2E9s4gsIo_s">The rules of delegation</a> (part 2)</li>
<li><a href="https://www.youtube.com/watch?v=CZcWZokRRac">Scaling cooperation</a> (part 3)</li>
<li><a href="https://www.youtube.com/watch?v=shEL7lrYeoY">Scaling goals</a> (part 4)</li>

</ul></li>

</ul>

</section>
<section id="slide-org7504345">
<h3 id="org7504345">Deeper still</h3>
<ul>
<li><a href="https://www.amazon.com/Thinking-Promises-Mark-Burgess-ebook/dp/B01092PYG8/ref=pd_cp_351_2?ie=UTF8&amp;refRID=P8MMWZ7H2X6B52JEAHNB">Thinking in Promises</a></li>
<li><a href="https://www.amazon.com/Search-Certainty-Science-Information-Infrastructure-ebook/dp/B00WL6SPR6/ref=pd_sim_351_3?ie=UTF8&amp;dpID=61EbYHkv7NL&amp;dpSrc=sims&amp;preST=_OU01_AC_UL160_SR107%2C160_&amp;refRID=R1NF58A2W7Z570MN6V3P">In Search of Certainty</a></li>
<li><a href="https://www.amazon.com/Promise-Theory-Principles-Applications-1/dp/1495437779/">Promise Theory: Principals and Applicationcs</a></li>

</ul>

<p>
<img src="./media/thinking-in-promises-cover.jpg" alt="thinking-in-promises-cover.jpg" /> <img src="./media/in-search-of-certainty-cover.png" alt="in-search-of-certainty-cover.png" />
</p>

</section>
</section>
<section>
<section id="slide-org1dacad0">
<h2 id="org1dacad0">Promises</h2>
</section>
<section id="slide-orgeb5fb07">
<h3 id="orgeb5fb07">Anatomy of a Promise</h3>
<div class="org-src-container">
<label class="org-src-name">Promise skeleton</label>
<pre  class="src src-artist">bundle bundle_type bundle_name
{
  type:
    context::
      <span style="color: #b8bb26;">"promiser"</span> -&gt; { <span style="color: #b8bb26;">"promisee"</span>, <span style="color: #b8bb26;">"stakeholder"</span> }
                      ----------|
        attribute1 =&gt; <span style="color: #b8bb26;">"value"</span>,  |
        attribute2 =&gt; body,     |-- Promise Body
        attributeN =&gt; bundle;   |
}                     ----------|
</pre>
</div>

</section>
<section id="slide-orgced6138">
<h3 id="orgced6138">Anatomy of a Promise: bundle_type</h3>
<div class="org-src-container">
<label class="org-src-name">Promise skeleton</label>
<pre  class="src src-artist">bundle bundle_type bundle_name
{
  type:
    context::
      <span style="color: #b8bb26;">"promiser"</span> -&gt; { <span style="color: #b8bb26;">"promisee"</span>, <span style="color: #b8bb26;">"stakeholder"</span> }
                      ----------|
        attribute1 =&gt; <span style="color: #b8bb26;">"value"</span>,  |
        attribute2 =&gt; body,     |-- Promise Body
        attributeN =&gt; bundle;   |
}                     ----------|
</pre>
</div>

<dl>
<dt><code>bundle_type</code></dt><dd>The type of bundle the promise resides in. Promises must be
inside of a bundle. Different bundle types are handled by
different agents (<code>cf-agent</code>, <code>cf-serverd</code>, <code>cf-monitord</code>).</dd>

</dl>

</section>
<section id="slide-org3cc09e8">
<h3 id="org3cc09e8">Anatomy of a Promise: bundle_name</h3>
<div class="org-src-container">
<label class="org-src-name">Promise skeleton</label>
<pre  class="src src-artist">bundle bundle_type bundle_name
{
  type:
    context::
      <span style="color: #b8bb26;">"promiser"</span> -&gt; { <span style="color: #b8bb26;">"promisee"</span>, <span style="color: #b8bb26;">"stakeholder"</span> }
                      ----------|
        attribute1 =&gt; <span style="color: #b8bb26;">"value"</span>,  |
        attribute2 =&gt; body,     |-- Promise Body
        attributeN =&gt; bundle;   |
}                     ----------|
</pre>
</div>

<dl>
<dt><code>bundle_name</code></dt><dd>The name of the bundle the promise resides in.</dd>

</dl>

</section>
<section id="slide-org5de0294">
<h3 id="org5de0294">Anatomy of a Promise: type</h3>
<div class="org-src-container">
<label class="org-src-name">Promise skeleton</label>
<pre  class="src src-artist">bundle bundle_type bundle_name
{
  type:
    context::
      <span style="color: #b8bb26;">"promiser"</span> -&gt; { <span style="color: #b8bb26;">"promisee"</span>, <span style="color: #b8bb26;">"stakeholder"</span> }
                      ----------|
        attribute1 =&gt; <span style="color: #b8bb26;">"value"</span>,  |
        attribute2 =&gt; body,     |-- Promise Body
        attributeN =&gt; bundle;   |
}                     ----------|
</pre>
</div>

<dl>
<dt><code>type:</code></dt><dd>Marks the start of a section of promises. The kind of promise being
made (e.g., <code>files</code>, <code>commands</code>, <code>packages</code>, etc &#x2026;).</dd>

</dl>

</section>
<section id="slide-orgbb810b2">
<h3 id="orgbb810b2">Anatomy of a Promise: context</h3>
<div class="org-src-container">
<label class="org-src-name">Promise skeleton</label>
<pre  class="src src-artist">bundle bundle_type bundle_name
{
  type:
    context::
      <span style="color: #b8bb26;">"promiser"</span> -&gt; { <span style="color: #b8bb26;">"promisee"</span>, <span style="color: #b8bb26;">"stakeholder"</span> }
                      ----------|
        attribute1 =&gt; <span style="color: #b8bb26;">"value"</span>,  |
        attribute2 =&gt; body,     |-- Promise Body
        attributeN =&gt; bundle;   |
}                     ----------|
</pre>
</div>

<dl>
<dt><code>context::</code></dt><dd>Optional, defaults to <code>any::</code> (no restriction, run on any
host). The context restriction applies until the next
context/class expression or until it's reset to default at the
start of the next promise type.</dd>

</dl>

</section>
<section id="slide-orgd77f60c">
<h3 id="orgd77f60c">Anatomy of a Promise: promiser</h3>
<div class="org-src-container">
<label class="org-src-name">Promise skeleton</label>
<pre  class="src src-artist">bundle bundle_type bundle_name
{
  type:
    context::
      <span style="color: #b8bb26;">"promiser"</span> -&gt; { <span style="color: #b8bb26;">"promisee"</span>, <span style="color: #b8bb26;">"stakeholder"</span> }
                      ----------|
        attribute1 =&gt; <span style="color: #b8bb26;">"value"</span>,  |
        attribute2 =&gt; body,     |-- Promise Body
        attributeN =&gt; bundle;   |
}                     ----------|
</pre>
</div>

<dl>
<dt><code>promiser</code></dt><dd>What is making the promise. (e.g., a <b>file</b>).</dd>

</dl>

</section>
<section id="slide-org10ec3eb">
<h3 id="org10ec3eb">Anatomy of a Promise: promisee/stakeholder</h3>
<div class="org-src-container">
<label class="org-src-name">Promise skeleton</label>
<pre  class="src src-artist">bundle bundle_type bundle_name
{
  type:
    context::
      <span style="color: #b8bb26;">"promiser"</span> -&gt; { <span style="color: #b8bb26;">"promisee"</span>, <span style="color: #b8bb26;">"stakeholder"</span> }
                      ----------|
        attribute1 =&gt; <span style="color: #b8bb26;">"value"</span>,  |
        attribute2 =&gt; body,     |-- Promise Body
        attributeN =&gt; bundle;   |
}                     ----------|
</pre>
</div>

<dl>
<dt><code>promisee/stakeholder</code></dt><dd>An optional recipient or beneficiary of the promise
(who cares about the promise). Promisees provide documentation for cross
referencing, primarily for humans.</dd>

</dl>

</section>
<section id="slide-org1a74b38">
<h3 id="org1a74b38">Anatomy of a Promise: promise body</h3>
<div class="org-src-container">
<label class="org-src-name">Promise skeleton</label>
<pre  class="src src-artist">bundle bundle_type bundle_name
{
  type:
    context::
      <span style="color: #b8bb26;">"promiser"</span> -&gt; { <span style="color: #b8bb26;">"promisee"</span>, <span style="color: #b8bb26;">"stakeholder"</span> }
                      ----------|
        attribute1 =&gt; <span style="color: #b8bb26;">"value"</span>,  |
        attribute2 =&gt; body,     |-- Promise Body
        attributeN =&gt; bundle;   |
}                     ----------|
</pre>
</div>

<dl>
<dt><code>promise body</code></dt><dd>A collection of promise attributes (not to be confused with
a body used as an attribute value)</dd>

</dl>

</section>
<section id="slide-org247c1d6">
<h3 id="org247c1d6">Anatomy of a Promise: value</h3>
<div class="org-src-container">
<label class="org-src-name">Promise skeleton</label>
<pre  class="src src-artist">bundle bundle_type bundle_name
{
  type:
    context::
      <span style="color: #b8bb26;">"promiser"</span> -&gt; { <span style="color: #b8bb26;">"promisee"</span>, <span style="color: #b8bb26;">"stakeholder"</span> }
                      ----------|
        attribute1 =&gt; <span style="color: #b8bb26;">"value"</span>,  |
        attribute2 =&gt; body,     |-- Promise Body
        attributeN =&gt; bundle;   |
}                     ----------|
</pre>
</div>

<dl>
<dt><code>value</code></dt><dd>A value to be used by a promise attribute. Attributes that take
values (in contrast to bodies and bundles) are not complex and have
a limited range of input. Note, promise attributes that do not take
bundles or bodies <b>must be quoted</b>.</dd>

</dl>

</section>
<section id="slide-org9291155">
<h3 id="org9291155">Anatomy of a Promise: body</h3>
<div class="org-src-container">
<label class="org-src-name">Promise skeleton</label>
<pre  class="src src-artist">bundle bundle_type bundle_name
{
  type:
    context::
      <span style="color: #b8bb26;">"promiser"</span> -&gt; { <span style="color: #b8bb26;">"promisee"</span>, <span style="color: #b8bb26;">"stakeholder"</span> }
                      ----------|
        attribute1 =&gt; <span style="color: #b8bb26;">"value"</span>,  |
        attribute2 =&gt; body,     |-- Promise Body
        attributeN =&gt; bundle;   |
}                     ----------|
</pre>
</div>

<dl>
<dt><code>body</code></dt><dd>A collection of attribute values. Note, promise attributes that take
bodies <b>must not be quoted</b>.</dd>

</dl>

</section>
<section id="slide-orge335f82">
<h3 id="orge335f82">Anatomy of a Promise: bundle</h3>
<div class="org-src-container">
<label class="org-src-name">Promise skeleton</label>
<pre  class="src src-artist">bundle bundle_type bundle_name
{
  type:
    context::
      <span style="color: #b8bb26;">"promiser"</span> -&gt; { <span style="color: #b8bb26;">"promisee"</span>, <span style="color: #b8bb26;">"stakeholder"</span> }
                      ----------|
        attribute1 =&gt; <span style="color: #b8bb26;">"value"</span>,  |
        attribute2 =&gt; body,     |-- Promise Body
        attributeN =&gt; bundle;   |
}                     ----------|
</pre>
</div>

<dl>
<dt><code>bundle</code></dt><dd>A collection of promises. Complex promise attributes like
<code>edit_line</code> take bundles. Note, promise attributes that take
bundles <b>must not be quoted</b>;</dd>

</dl>

</section>
<section id="slide-org9c51722">
<h3 id="org9c51722">Promise Attributes</h3>
<ul>
<li>Separated by commas</li>
<li>Vary by <b>promise type</b></li>
<li>Value is quoted string or unquoted object (function/body/bundle)</li>

</ul>

<aside class="notes">
<p>
Each promise can have one or more attributes that describe the parameters of the
promise. The available attributes will vary depending on the <b>promise type</b>.
</p>

<p>
The value can be either a text string (which must be quoted) or another object
(which must not be quoted). All of the attributes together are called the
<b>promise body</b> of the promise (as in "the body of an e-mail", or "the body of a
contract").
</p>

<p>
When an attribute value is a body the body specified <b>must have a type matching
the attribute name</b>.
</p>

<p>
Attributes are separated by <b>commas</b>. Each promise ends with a <b>semicolon</b>.
</p>

</aside>

</section>
<section id="slide-org1acd4d5">
<h3 id="org1acd4d5">Example Promise</h3>
<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">files</span>:
    <span style="color: #fb4933;">linux</span>::
      <span style="color: #b8bb26;">"/tmp/example"</span> -&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"Instructor"</span>, <span style="color: #b8bb26;">"Students"</span> <span style="color: #b16286;">}</span>
        create =&gt; <span style="color: #b8bb26;">"true"</span>,
        touch =&gt; <span style="color: #b8bb26;">"true"</span>,
        action =&gt; warn_only;
<span style="color: #458588;">}</span>
</pre>
</div>

<pre class="example">
# cf-agent --no-lock --file ./examples/example_promise.cf
 warning: Warning promised, need to create file '/tmp/example'
</pre>


<aside class="notes">
<ul>
<li>This is a promise of <b>type</b> <code>files</code>.</li>
<li>This promise has a <b>class context</b> of <code>linux</code> (it will only apply if running a
Linux kernel).</li>
<li>The <b>promiser</b> is the POSIX path <code>/tmp/example</code>.</li>
<li>This promise has three <b>attribute</b>, specifying that the file should be
created if it does not exist, it's timestamp should be updated, and only
warn about what the agent would do.</li>
<li>The <b>promisee</b> is both of us</li>
<li>To create a directory instead, use a <code>files:</code> promise and append a <code>.</code> to the
directory name (e.g., <code>/tmp/hello/.</code>)</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-org8e860f1">
<h2 id="org8e860f1">Bundles</h2>
<ul>
<li>collection of <b>promises</b></li>
<li>logical grouping</li>
<li>can have parameters</li>
<li><b>ARE NOT FUNCTIONS</b></li>

</ul>

</section>
<section id="slide-org51ab4cf">
<h3 id="org51ab4cf">Anatomy of a Bundle</h3>
<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">type</span> <span style="color: #fabd2f;">name</span>
<span style="color: #458588;">{</span>
    <span style="color: #fe8019;">type</span>:
      <span style="color: #fb4933;">context</span>::
        <span style="color: #b8bb26;">"promiser"</span> -&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"promisee"</span> <span style="color: #b16286;">}</span>
          attribute1 =&gt; <span style="color: #b8bb26;">"value"</span>,
          attribute2 =&gt; value;

    <span style="color: #fe8019;">type</span>:
      <span style="color: #fb4933;">context</span>::
        <span style="color: #b8bb26;">"promiser"</span> -&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"promisee"</span> <span style="color: #b16286;">}</span>
          attribute1 =&gt; <span style="color: #b8bb26;">"value"</span>,
          attribute2 =&gt; value;
<span style="color: #458588;">}</span>
</pre>
</div>

<p>
Bundles apply to the binary that executes them. E.g., <code>agent</code> bundles apply to
<code>cf-agent</code> while <code>server</code> bundles apply to <code>cf-serverd</code>.
</p>

<p>
Bundles of type <code>common</code> apply to any CFEngine binary.
</p>

</section>
<section id="slide-orgd9decb7">
<h3 id="orgd9decb7">A bundle for Apache web-server might</h3>
<ul>
<li>ensure the <code>apache2</code> package is installed</li>
<li>ensure the content in the config file is correct</li>
<li>ensure content is present for serving</li>
<li>ensure proper permissions of files</li>
<li>ensure the <code>httpd</code> process is running</li>
<li>ensure the <code>httpd</code> process is restarted when the configuration changes</li>

</ul>

</section>
<section id="slide-orgb14c0e5">
<h3 id="orgb14c0e5">How bundles hold state</h3>
<p>
This matters when you call the same bundle more than one time within a given
execution.
</p>

<ul>
<li>Classic arrays are cleared at the beginning of a bundle actuation.</li>
<li>Lists, strings, ints, reals, and data-containers are preserved but can be
re-defined if not guarded with <code>if =&gt; isvariable()</code>.</li>
<li>bundle scoped classes are cleared at the end of the bundles execution</li>
<li>namespace scoped classes are not cleared automatically, though they can be
explicitly undefined.</li>

</ul>

</section>
<section id="slide-orgb4c974d">
<h3 id="orgb4c974d">Quiz: What component(s) use this bundle?</h3>
<div class="outline-text-3" id="text-orgb4c974d">
</div>
</section>
<section id="slide-orgeaf70d0">
<h4 id="orgeaf70d0">What component(s) use common bundles?</h4>
<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">common</span> <span style="color: #fabd2f;">globals</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">vars</span>:

      <span style="color: #b8bb26;">"tool_path"</span> <span style="color: #d3869b;">string</span> =&gt; <span style="color: #b8bb26;">"/srv/tools"</span>
<span style="color: #458588;">}</span>
</pre>
</div>

<aside class="notes">
<ul>
<li>cf-agent, cf-monitord, cf-serverd</li>

</ul>

</aside>

</section>
<section id="slide-org71f6a26">
<h4 id="org71f6a26">What component(s) use server bundles?</h4>
<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">server</span> <span style="color: #fabd2f;">my_access_rules</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">access</span>:

      <span style="color: #b8bb26;">"$(globals.tool_path)"</span>
        admit_ips =&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"192.168.0.0/24"</span> <span style="color: #b16286;">}</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

</section>
<section id="slide-orgf1e4cb4">
<h4 id="orgf1e4cb4">What component(s) use agent bundles?</h4>
<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">my_policy</span>
<span style="color: #458588;">{</span>

  <span style="color: #fe8019;">vars</span>:

    <span style="color: #b8bb26;">"config[PermitRootLogin]"</span> <span style="color: #d3869b;">string</span> =&gt; <span style="color: #b8bb26;">"no"</span>;
    <span style="color: #b8bb26;">"config[Port]"</span> <span style="color: #d3869b;">string</span> =&gt; <span style="color: #b8bb26;">"22"</span>;

  <span style="color: #fe8019;">files</span>:

      <span style="color: #b8bb26;">"/etc/ssh/sshd_config"</span>
        edit_line =&gt; set_line_based<span style="color: #b16286;">(</span> <span style="color: #b8bb26;">"my_policy.config"</span>, <span style="color: #b8bb26;">" "</span>, <span style="color: #b8bb26;">"\s+"</span>, <span style="color: #b8bb26;">".*"</span>, <span style="color: #b8bb26;">"\s*#\s*"</span><span style="color: #b16286;">)</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

</section>
<section id="slide-org46ee083">
<h4 id="org46ee083">What component(s) use monitor bundles?</h4>
<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">monitor</span> <span style="color: #fabd2f;">measure_cf_serverd</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">vars</span>:

    <span style="color: #b8bb26;">"pid[cf-serverd]"</span>
      <span style="color: #d3869b;">string</span> =&gt; readfile<span style="color: #b16286;">(</span> <span style="color: #b8bb26;">"$(sys.piddir)/cf-serverd.pid"</span>, <span style="color: #d3869b;">4k</span> <span style="color: #b16286;">)</span>;

    <span style="color: #b8bb26;">"reg_stat[rss]"</span> <span style="color: #d3869b;">string</span> =&gt;<span style="color: #b8bb26;">"(?:[^\s+]*\s+){23}([^\s]+)(?:.*)"</span>;

  <span style="color: #fe8019;">measurements</span>:

   <span style="color: #b8bb26;">"/proc/$(pid[cf-serverd])/stat"</span>
     handle =&gt; <span style="color: #b8bb26;">"cf_serverd_vsize"</span>,
     stream_type =&gt; <span style="color: #b8bb26;">"file"</span>,
     data_type =&gt; <span style="color: #b8bb26;">"int"</span>,
     history_type =&gt; <span style="color: #b8bb26;">"weekly"</span>,
     units =&gt; <span style="color: #b8bb26;">"pages in memory"</span>,
     match_value =&gt; line_match_value<span style="color: #b16286;">(</span><span style="color: #b8bb26;">".*"</span>, $<span style="color: #8ec07c;">(</span>reg_stat<span style="color: #d65d0e;">[</span>rss<span style="color: #d65d0e;">]</span><span style="color: #8ec07c;">)</span> <span style="color: #b16286;">)</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

</section>
</section>
<section>
<section id="slide-org3c3d133">
<h2 id="org3c3d133">Bodies</h2>
<p>
I stated before that the attributes of a promise, collectively, are called the
body. Depending on the specific attribute the value of an attribute can be an
<b>external body</b>.
</p>

<p>
A <b>body</b> is a collection of <i>attributes</i>. These are attributes that supplement
the promise.
</p>

</section>
<section id="slide-org5a553db">
<h3 id="org5a553db">Anatomy of an external body</h3>
<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">body</span> <span style="color: #d3869b;">TYPE</span> <span style="color: #fabd2f;">NAME</span><span style="color: #458588;">(</span><span style="color: #83a598;">OPTIONAL, PARAMS</span><span style="color: #458588;">)</span>
<span style="color: #458588;">{</span>
        ATTRIBUTE =&gt; <span style="color: #b8bb26;">"value"</span>;
        ATTRIBUTEn =&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"more"</span>, <span style="color: #b8bb26;">"values"</span> <span style="color: #b16286;">}</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<p>
The difference between a <i>bundle</i> and a <i>body</i> is that a bundle contains
<i>promises</i> while a <i>body</i> contains only <i>attributes</i>.
</p>

</section>
<section id="slide-orgfc8e7e0">
<h4 id="orgfc8e7e0">Take a moment to let this sink in</h4>
<ul>
<li>A <b>bundle</b> is a collection of <i>promises</i>.</li>
<li>A <b>body</b> is a collection of <i>attributes</i> that are applied to a promise.</li>

</ul>

<p>
The distinction is subtle, especially at first and many people are tripped up by
this.
</p>

<p>
In a body, each attribute ends with a <b>semicolon</b>.
</p>

<p>
(Note that in a bundle each promise ends with a <b>semicolon</b>, while attributes of
each promise are separated by <b>commas</b>)
</p>

</section>
<section id="slide-org8e86289">
<h3 id="org8e86289">Example showing use of external body</h3>
<div class="org-src-container">
<label class="org-src-name">The <code>m</code> perms body takes one paramater</label>
<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">files</span>:
      <span style="color: #b8bb26;">"/tmp/file"</span>
        perms =&gt; m<span style="color: #b16286;">(</span><span style="color: #d3869b;">600</span><span style="color: #b16286;">)</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

</section>
<section id="slide-org53c164c">
<h4 id="org53c164c">What is m?</h4>
<aside class="notes">
<p>
Bodies and bundles that ship as part of the MPF are documented in-line and are
rendered in the Masterfiles Policy Framework section of the Reference Manual
at docs.cfengine.com.
</p>

</aside>

<p>
<b>PRO TIP:</b> The <a href="https://github.com/cfengine/core/tree/master/contrib/cf-locate"><code>cf-locate</code></a> script in <a href="https://github.com/cfengine/core/tree/master/contrib/">core/contrib</a> can help you find and view
body and bundle definitions within your policy set.
</p>

<div class="org-src-container">
<label class="org-src-name">Example running cf-locate to see the details of an external body</label>
<pre  class="src src-sh">cf-locate --plain --full <span style="color: #b8bb26;">"perms m\(.*"</span>
</pre>
</div>

<pre class="example">

body perms m(mode)
# @brief Set the file mode
# @param mode The new mode
{
      mode   =&gt; "$(mode)";
}
</pre>

</section>
</section>
<section>
<section id="slide-org3e83e11">
<h2 id="org3e83e11">Abstraction and Re-usability</h2>
<p>
Bundles and bodies can be paramaterized for abstraction and re-usability. In
other words you can define one and call it even passing in parameters which will
implicitly become variables.
</p>

</section>
<section id="slide-org68d7902">
<h3 id="org68d7902">Example</h3>
<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">body</span> <span style="color: #d3869b;">type</span> <span style="color: #fabd2f;">name</span> <span style="color: #458588;">(</span>my_param<span style="color: #458588;">)</span> <span style="color: #458588;">{</span>
  attribute1 =&gt; <span style="color: #b8bb26;">"$(my_param)"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<p>
The parameter <code>my_param</code> is accessed as a variable by <code>$(my_param)</code>.
</p>

</section>
</section>
<section>
<section id="slide-orgd029dad">
<h2 id="orgd029dad">The Masterfiles Policy Framework</h2>
<p>
The <b>Masterfiles Policy Framework</b> is the default policy that ships with
CFEngine. The standard library is included.
</p>

<ul>
<li><a href="https://github.com/cfengine/masterfiles">Source</a></li>
<li><a href="https://docs.cfengine.com/docs/3.12/reference-masterfiles-policy-framework.html">Documentation</a></li>

</ul>

</section>
<section id="slide-orgf7149e8">
<h3 id="orgf7149e8">CFEngine Standard Library</h3>
<p>
The <b>CFEngine Standard Library</b> comes bundled with CFEngine in the
<code>masterfiles/lib/</code> directory.
</p>

<p>
The standard library contains ready to use bundles and bodies that you can
include in your promises and is growing with every version of CFEngine. Get to
know the standard library well, it will save you much time.
</p>

<ul>
<li><a href="https://github.com/cfengine/masterfiles/tree/master/lib">Source</a></li>
<li><a href="https://docs.cfengine.com/lts/reference-masterfiles-policy-framework-lib.html">Documentation</a></li>

</ul>

</section>
</section>
<section>
<section id="slide-orge82ba8e" data-background="./media/building_blocks.jpg">
<h2 id="orge82ba8e">Putting it all together</h2>

</section>
</section>
<section>
<section id="slide-org34f975c">
<h2 id="org34f975c">A few examples</h2>
<ul>
<li><a href="https://github.com/nickanderson/CFEngine-zero-to-hero-primer/tree/master/examples">examples</a></li>

</ul>

</section>
<section id="slide-org76b503b">
<h3 id="org76b503b">Executing the agent</h3>
<pre class="example">
$ cf-agent --no-locks --log-level=info --file ./test.cf --bundle bundlename
</pre>

<p>
<b>Note:</b> Make sure you use the correct file and bundle name! For any examples
including a bundle named main or <span class="underline"><span class="underline">main</span></span> you can skip specifying the bundle.
</p>

</section>
<section id="slide-orgc077065">
<h3 id="orgc077065">A quick note on promise locking</h3>
<p>
By default promises (excluding defaults, vars, classes, and methods) are locked
for 1 minute once they are evaluated. 
</p>

<div class="org-src-container">
<label class="org-src-name">Execute the same policy multiple times over course of minute to see locking</label>
<pre  class="src src-sh"><span style="color: #fb4933;">for</span> i<span style="color: #fb4933;"> in</span> $<span style="color: #458588;">(</span>seq <span style="color: #d3869b;">3</span><span style="color: #458588;">)</span>; <span style="color: #fb4933;">do</span>
  cf-agent -f ./examples/reports_show_locking.cf
  sleep <span style="color: #d3869b;">30</span> 
<span style="color: #fb4933;">done</span>
</pre>
</div>

<pre class="example">
R: I started running CFEngine 3.14.0a.4e12fcf75 at 'Fri Jul 19 11:23:01 2019'
R: Hello World!
R: I started running CFEngine 3.14.0a.4e12fcf75 at 'Fri Jul 19 11:23:31 2019'
R: I started running CFEngine 3.14.0a.4e12fcf75 at 'Fri Jul 19 11:24:01 2019'
R: Hello World!
</pre>

</section>
<section id="slide-org3dd3e3a">
<h4 id="org3dd3e3a">Inspecting the policy</h4>
<div class="org-src-container">
<label class="org-src-name">examples/reports_show_locking.cf/</label>
<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">reports</span>:
      <span style="color: #b8bb26;">"I started running CFEngine $(sys.cf_version) at '$(sys.date)'"</span>
        action =&gt; immediate; 
      <span style="color: #b8bb26;">"Hello World!"</span>;
<span style="color: #458588;">}</span>
<span style="color: #fe8019;">body</span> <span style="color: #d3869b;">action</span> <span style="color: #fabd2f;">immediate</span>
<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">@brief Evaluate the promise at every `cf-agent` execution.</span>
<span style="color: #458588;">{</span>
    ifelapsed =&gt; <span style="color: #b8bb26;">"0"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>


</section>
<section id="slide-org85062a8">
<h3 id="org85062a8">Running commands</h3>
<div class="org-src-container">
<label class="org-src-name">examples/commands_echo_hello_world.cf</label>
<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">commands</span>:
      <span style="color: #b8bb26;">"/bin/echo Hello World!"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<pre class="example">
# cf-agent --no-lock --file ./examples/commands_echo_hello_world.cf
  notice: Q: ".../bin/echo Hello": Hello World!
</pre>


<aside class="notes">
<p>
Commands are <b>not</b> the best way to accomplish automation.
</p>

<ul>
<li>Can hide important details.</li>
<li>Not the most efficient way to collect information.</li>

</ul>

</aside>

</section>
<section id="slide-orgf6c9b5a">
<h3 id="orgf6c9b5a">Set File Permissions</h3>
<div class="org-src-container">
<label class="org-src-name">examples/set_file_permissions.cf</label>
<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">files</span>:
    <span style="color: #b8bb26;">"/etc/shadow"</span>     perms =&gt; perms_for_shadow_files;
    <span style="color: #b8bb26;">"/etc/gshadow"</span>    perms =&gt; perms_for_shadow_files;

  <span style="color: #fe8019;">reports</span>:
    <span style="color: #b8bb26;">"Please run this policy as root"</span>
      if =&gt; not<span style="color: #b16286;">(</span> strcmp<span style="color: #8ec07c;">(</span> <span style="color: #b8bb26;">"$(sys.user_data[gid])"</span>, <span style="color: #b8bb26;">"0"</span> <span style="color: #8ec07c;">)</span> <span style="color: #b16286;">)</span>; 
<span style="color: #458588;">}</span>

<span style="color: #fe8019;">body</span> <span style="color: #d3869b;">perms</span> <span style="color: #fabd2f;">perms_for_shadow_files</span> <span style="color: #458588;">{</span>
  owners =&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"root"</span> <span style="color: #b16286;">}</span>;
  groups =&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"root"</span> <span style="color: #b16286;">}</span>;
  mode   =&gt; <span style="color: #b8bb26;">"0640"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<ul>
<li>This is an <b>agent</b> bundle (meaning that it is processed by <code>cf-agent</code>).</li>
<li>Its purpose is to set the permissions on <code>/etc/shadow</code> and <code>/etc/gshadow</code>.</li>
<li>It uses an external body named <code>perms_for_shadow_files</code>.</li>
<li>The body only needs to be defined once and can be reused for any number of
promises.</li>

</ul>

<p>
Note: The values for <code>owners</code> and <code>groups</code> is enclosed in curly braces. This is
because these attributes take a list of strings (aka, an <code>slist</code>).
</p>

</section>
<section id="slide-orge1fe0cb">
<h3 id="orge1fe0cb">Copy an entire file</h3>
<div class="org-src-container">
<label class="org-src-name">examples/example_copy_file.cf</label>
<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">example</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">files</span>:
    <span style="color: #b8bb26;">"/etc/motd"</span> copy_from =&gt; cp<span style="color: #b16286;">(</span><span style="color: #b8bb26;">"/repo/motd"</span><span style="color: #b16286;">)</span>;
<span style="color: #458588;">}</span>

<span style="color: #fe8019;">body</span> <span style="color: #d3869b;">copy_from</span> <span style="color: #fabd2f;">cp</span> <span style="color: #458588;">(</span>from<span style="color: #458588;">)</span> <span style="color: #458588;">{</span>
  servers     =&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"$(sys.policy_hub)"</span> <span style="color: #b16286;">}</span>;
  source      =&gt; <span style="color: #b8bb26;">"$(from)"</span>;
  compare     =&gt; <span style="color: #b8bb26;">"digest"</span>;
<span style="color: #458588;">}</span>
<span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">server</span> <span style="color: #fabd2f;">my_access_rules</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">access</span>:
    <span style="color: #fb4933;">policy_server|am_policy_hub</span>::
      <span style="color: #b8bb26;">"/repo"</span>
        admit_ips =&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"192.168.0.1/24"</span> <span style="color: #b16286;">}</span>,
        admit_keys =&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"SHA=12345"</span> <span style="color: #b16286;">}</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<aside class="notes">
<ul>
<li>The purpose of this policy is to copy <code>/etc/motd</code> from the CFEngine server</li>
<li><code>$(sys.policy_hub)</code> is an automatic variable which contains the CFEngine
server's address.</li>
<li>The path <code>/repo/motd</code> is on the <i>server's</i> filesystem.</li>
<li>The <code>compare</code> type tells CFEngine how to know when the file needs updating.</li>

</ul>

</aside>

</section>
<section id="slide-org56bdb05">
<h4 id="org56bdb05">Copy an entire file agent bundle</h4>
<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">example</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">files</span>:
    <span style="color: #b8bb26;">"/etc/motd"</span>     copy_from =&gt; cp<span style="color: #b16286;">(</span><span style="color: #b8bb26;">"/repo/motd"</span><span style="color: #b16286;">)</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<ul>
<li>The file <code>/etc/motd</code> should be a copy of a file described by the <code>cp</code>
<code>copy_from</code> body.</li>

</ul>

</section>
<section id="slide-orgdc427c2">
<h4 id="orgdc427c2">Copy an entire file <code>copy_from</code> body</h4>
<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">body</span> <span style="color: #d3869b;">copy_from</span> <span style="color: #fabd2f;">cp</span> <span style="color: #458588;">(</span>from<span style="color: #458588;">)</span> <span style="color: #458588;">{</span>
  servers     =&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"$(sys.policy_hub)"</span> <span style="color: #b16286;">}</span>;
  source      =&gt; <span style="color: #b8bb26;">"$(from)"</span>;
  compare     =&gt; <span style="color: #b8bb26;">"digest"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<dl>
<dt><code>source</code></dt><dd>The path to the file that should be copied.</dd>
<dt><code>servers</code></dt><dd>Servers which the file should be attempted to be copied from.</dd>
<dt><code>compare</code></dt><dd>How to determine if the file differs and requires update.</dd>

</dl>

</section>
<section id="slide-org9e89fcb">
<h4 id="org9e89fcb">Copy an entire file <code>server</code> bundle</h4>
<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">server</span> <span style="color: #fabd2f;">my_access_rules</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">access</span>:
    <span style="color: #fb4933;">policy_server|am_policy_hub</span>::
      <span style="color: #b8bb26;">"/repo"</span>
        admit_ips =&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"192.168.0.1/24"</span> <span style="color: #b16286;">}</span>,
        admit_keys =&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"SHA=12345"</span> <span style="color: #b16286;">}</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<dl>
<dt><code>admit_ips</code></dt><dd>List of IPs or subnets that should be allowed to copy from
<code>/repo</code>.</dd>
<dt><code>admi_keys</code></dt><dd>List of cfengine ids that should be allowed to copy from
<code>/repo</code>.</dd>

</dl>

</section>
<section id="slide-org5183c40">
<h3 id="org5183c40">Edit a File</h3>
<div class="org-src-container">
<label class="org-src-name">examples/sshd_permit_root_login_no.cf</label>
<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">files</span>:
    <span style="color: #b8bb26;">"/etc/ssh/sshd_config"</span>     edit_line =&gt; deny_root_ssh;
<span style="color: #458588;">}</span>

<span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">edit_line</span> <span style="color: #fabd2f;">deny_root_ssh</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">delete_lines</span>:
    <span style="color: #b8bb26;">"^PermitRootLogin.*"</span>;
  <span style="color: #fe8019;">insert_lines</span>:
    <span style="color: #b8bb26;">"PermitRootLogin no"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<aside class="notes">
<p>
Editing files is most useful when management must be shared between multiple
agents.
</p>

<ul>
<li>This will delete any line matching the regular expression <code>^PermitRootLogin.*</code>.</li>
<li>This also inserts the line <code>PermitRootLogin no</code> <b>at the end of the file</b>.</li>
<li>Delete is always applied before insert, so it will not delete the inserted line.</li>
<li>CFEngine is smart enough to know not to edit the file if the end result is
already <i>converged</i>.</li>
<li>This is an overly simplistic example. When editing configuration files you
probably want to copy the whole file or use <code>set_config_values()</code> from the
standard library.</li>

</ul>

</aside>

</section>
</section>
<section>
<section id="slide-orga23e95b">
<h2 id="orga23e95b">Variables</h2>
<p>
Can be one of several types:
</p>

<ul>
<li>strings</li>
<li>lists</li>
<li>numbers (int/real)</li>
<li>data (JSON/YAML/CSV/ENV)</li>

</ul>

<p>
Reference: <a href="https://docs.cfengine.com/lts/reference-special-variables.html">Special Variables</a>, <a href="https://docs.cfengine.com/lts/reference-language-concepts-variables.html">Language Concepts -&gt; Variables</a>, <a href="https://docs.cfengine.com/lts/reference-promise-types-vars.html">Promise Types and
Attributes -&gt; vars</a>
</p>

</section>
<section id="slide-orgb9342ff">
<h3 id="orgb9342ff">Implicit iteration</h3>
<p>
CFEngine doesn't have for loops, but it implicitly iterates over lists and data
structure values.
</p>

<div class="org-src-container">
<label class="org-src-name">implicit-iteration.cf</label>
<pre  class="src src-cfengine3" id="implicit-iteration"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">vars</span>:
      <span style="color: #b8bb26;">"l"</span> <span style="color: #d3869b;">slist</span> =&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"two"</span>, <span style="color: #b8bb26;">"one"</span>, <span style="color: #b8bb26;">"three"</span> <span style="color: #b16286;">}</span>;
      <span style="color: #b8bb26;">"d"</span> <span style="color: #d3869b;">data</span> =&gt; <span style="color: #b8bb26;">'[ "three", "one", "two"]'</span>;
      <span style="color: #b8bb26;">"d2"</span> <span style="color: #d3869b;">data</span> =&gt; <span style="color: #b8bb26;">'{ "one":"1", "two":"2", "three":"3"}'</span>;

  <span style="color: #fe8019;">reports</span>:
      <span style="color: #b8bb26;">"l contains $(l)"</span>;
      <span style="color: #b8bb26;">"d contains $(d)"</span>;
      <span style="color: #b8bb26;">"d2 contains $(d2)"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

</section>
<section id="slide-org05ee338">
<h4 id="org05ee338">Example output</h4>
<pre class="example">
# cf-agent --no-lock --file ./examples/list-iteration.cf
R: l contains two
R: l contains one
R: l contains three
R: d contains three
R: d contains one
R: d contains two
R: d2 contains 1
R: d2 contains 2
R: d2 contains 3
</pre>

</section>
<section id="slide-orga0f0745">
<h3 id="orga0f0745">Data and arrays</h3>
<div class="org-src-container">
<label class="org-src-name">examples/data-and-arrays.cf</label>
<pre  class="src src-cfengine3" id="data-and-arrays.cf"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">vars</span>:
      <span style="color: #b8bb26;">"d"</span> <span style="color: #d3869b;">data</span> =&gt; <span style="color: #b8bb26;">'{ "key": { "subkey": "value" } }'</span>;

      <span style="color: #b8bb26;">"a[key][subkey]"</span> <span style="color: #d3869b;">string</span> =&gt; <span style="color: #b8bb26;">"value"</span>;

  <span style="color: #fe8019;">reports</span>:
      <span style="color: #b8bb26;">"$(const.dollar)(d[key][subkey]) == $(d[key][subkey])"</span>;
      <span style="color: #b8bb26;">"$(const.dollar)(a[key][subkey]) == $(a[key][subkey])"</span>;
      <span style="color: #b8bb26;">"d contains$(const.n)$(with)"</span> with =&gt; string_mustache<span style="color: #b16286;">(</span> <span style="color: #b8bb26;">"{{%-top-}}"</span>, d <span style="color: #b16286;">)</span>;
      <span style="color: #b8bb26;">"a contains$(const.n)$(with)"</span> with =&gt; string_mustache<span style="color: #b16286;">(</span> <span style="color: #b8bb26;">"{{%-top-}}"</span>, a <span style="color: #b16286;">)</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

</section>
<section id="slide-orgabe3ab1">
<h4 id="orgabe3ab1">Example Output</h4>
<pre class="example">
# cf-agent --no-lock --file ./examples/data-and-arrays.cf
R: $(d[key][subkey]) == value
R: $(a[key][subkey]) == value
R: d contains
{
  "key": {
    "subkey": "value"
  }
}
R: a contains
{
  "key": {
    "subkey": "value"
  }
}
</pre>

</section>
</section>
<section>
<section id="slide-orgb576ad0">
<h2 id="orgb576ad0">Classification and Classes</h2>
<p>
A <b>class</b> is like a tag (like tagging a photo). Classes are used to give a
promise <b>context</b>. Valid characters in classes are [A-Za-z0-9_] (alphanumeric
and underscores). There are two types of classes.
</p>

<ul>
<li><b>Built in classes</b>. These <b>hard classes</b> are classes that CFEngine
will create automatically. Hard classes are determined based on the system
attributes. For example a server running Linux will have the class <code>linux</code>.</li>

<li><b>User defined classes</b>. These <b>soft classes</b> are classes that are
defined by you. You can create them based on the outcome of a promise, based
on the existence of other classes, or for no reason.</li>

</ul>

</section>
<section id="slide-org1f108a0">
<h3 id="org1f108a0">What classes are defined?</h3>
<p>
Use <code>cf-promsies --show-classes</code> to see the first order of resolved classes. 
</p>

<div class="org-src-container">
<label class="org-src-name">Example showing how to view first order classes</label>
<pre  class="src src-sh" id="cf-promsies --show-classes">cf-promises --show-classes | head
</pre>
</div>

</section>
<section id="slide-orged2ea3a">
<h4 id="orged2ea3a">sample cf-promises &#x2013;show-classes output</h4>
<pre class="example">
Class name                                                   Meta tags                               
127_0_0_1                                                    inventory,attribute_name=none,source=agent,hardclass
172_17_0_1                                                   inventory,attribute_name=none,source=agent,hardclass
172_27_224_133                                               inventory,attribute_name=none,source=agent,hardclass
192_168_122_1                                                inventory,attribute_name=none,source=agent,hardclass
192_168_42_189                                               inventory,attribute_name=none,source=agent,hardclass
4_cpus                                                       source=agent,derived-from=sys.cpus,hardclass
64_bit                                                       source=agent,hardclass                  
Afternoon                                                    time_based,cfengine_internal_time_based_autoremove,source=agent,hardclass
Day19                                                        time_based,cfengine_internal_time_based_autoremove,source=agent,hardclass
</pre>

</section>
<section id="slide-org30652a7">
<h3 id="org30652a7">Control Promise Selection</h3>
<div class="org-src-container">
<label class="org-src-name">examples/example_apache_config_copied.cf</label>
<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">apache_config</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">files</span>:

    <span style="color: #fb4933;">debian</span>::
      <span style="color: #b8bb26;">"/etc/apache2/apache2.conf"</span>
        copy_from =&gt; remote_cp<span style="color: #b16286;">(</span><span style="color: #b8bb26;">"/cfengine/repo/debian/apache2.conf"</span>,<span style="color: #b8bb26;">"$(sys.policy_hub)"</span><span style="color: #b16286;">)</span>;
    <span style="color: #fb4933;">redhat</span>::
      <span style="color: #b8bb26;">"/etc/httpd/conf/httpd.conf"</span>
        copy_from =&gt; remote_cp<span style="color: #b16286;">(</span><span style="color: #b8bb26;">"/cfengine/repo/redhat/httpd.conf"</span>,<span style="color: #b8bb26;">"$(sys.policy_hub)"</span><span style="color: #b16286;">)</span>;
    <span style="color: #fb4933;">solaris</span>::
      <span style="color: #b8bb26;">"/etc/apache2/2.2/httpd.conf"</span>
        copy_from =&gt; remote_cp<span style="color: #b16286;">(</span><span style="color: #b8bb26;">"/cfengine/repo/solaris/httpd.conf"</span>,<span style="color: #b8bb26;">"$(sys.policy_hub)"</span><span style="color: #b16286;">)</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<ul>
<li>Copy the appropriate config file for the given platform</li>
<li>Promises outside of the specified context are skipped</li>

</ul>

</section>
<section id="slide-org74a3c8b">
<h3 id="org74a3c8b">Promise Type and Class Context apply until they are reset</h3>
<div class="org-src-container">
<label class="org-src-name">examples/implicit_class_context.cf</label>
<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">example</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">files</span>:
    <span style="color: #fb4933;">solaris</span>::
      <span style="color: #b8bb26;">"/tmp/hello/world"</span>
        create =&gt; <span style="color: #b8bb26;">"true"</span>;
      <span style="color: #b8bb26;">"/tmp/foo/bar"</span>
        create =&gt; <span style="color: #b8bb26;">"true"</span>;
    <span style="color: #fb4933;">linux</span>::
      <span style="color: #b8bb26;">"/dev/shm/hello_world"</span>
        create =&gt; <span style="color: #b8bb26;">"true"</span>;
  <span style="color: #fe8019;">commands</span>:
      <span style="color: #b8bb26;">"/bin/echo Hello World"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<ul>
<li>New class expression sets context for following promises</li>
<li>New promise type resets context to <code>any</code> (implicit default)</li>

</ul>

<aside class="notes">
<p>
The <i>promise type</i> and <i>class context</i> don't need to be listed for every
promise. Think of each like a heading in an outline. Everything that follows is
still under the same heading until a new heading is declared. If a new promise
type is declared the class context is reset as well.
</p>

<p>
The first three promises are of type <code>files</code>. The first two will only execute on
<code>solaris</code> while the third will only execute on <code>linux</code>. The last promise has a
new promise type, of <code>commands</code>, and will always execute. (Context is implicitly
reset to <code>any::</code> when entering a new promise type.)
</p>

</aside>

</section>
<section id="slide-orga4ccfce">
<h3 id="orga4ccfce">Classes are NOT nested</h3>
<div class="org-src-container">
<label class="org-src-name">examples/example_no_nested_classes.cf</label>
<pre  class="src src-cfengine3" id="There are no nested contexts"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">reports</span>:
      <span style="color: #fb4933;">redhat</span>:: <span style="color: #7c6f64;"># &lt;- This context has no promises.</span>
        <span style="color: #d3869b;">64_bit</span>:: <span style="color: #7c6f64;"># &lt;- This context has one promise. (not additive)</span>
          <span style="color: #b8bb26;">"I am $(sys.flavor) running on $(sys.arch)"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<ul>
<li>No promises are defined in the <code>redhat</code> context</li>
<li>One promise is defined in the <code>64_bit</code> context</li>
<li>Nesting class expressions does not make them additive</li>

</ul>

<pre class="example">
# cf-agent --no-lock --file ./examples/example_no_nested_classes.cf
R: I am ubuntu_19 running on x86_64
</pre>

</section>
<section id="slide-orgbef176d">
<h3 id="orgbef176d">Use Classes to Control Flow</h3>
<div class="org-src-container">
<label class="org-src-name">examples/example_config_repair_triggers_command.cf</label>
<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">apache_config</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">commands</span>:

    <span style="color: #fb4933;">apache_config_repaired</span>::
      <span style="color: #b8bb26;">"/usr/sbin/apache2ctl graceful"</span>;

  <span style="color: #fe8019;">files</span>:

    <span style="color: #b8bb26;">"/etc/apache2/apache2.conf"</span>
        copy_from =&gt; remote_cp<span style="color: #b16286;">(</span><span style="color: #b8bb26;">"/cfengine/repo/debian/apache2.conf"</span>,
                               $<span style="color: #8ec07c;">(</span><span style="color: #83a598;">sys.policy_hub</span><span style="color: #8ec07c;">)</span><span style="color: #b16286;">)</span>,
        classes =&gt; results<span style="color: #b16286;">(</span><span style="color: #b8bb26;">"bundle"</span>, <span style="color: #b8bb26;">"apache_config"</span><span style="color: #b16286;">)</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<ul>
<li>Only when the apache config is updated define <code>apache_config_repaired</code>.</li>
<li>Only when <code>apache_config_repaired</code> is defined execute the command to restart
the service.</li>

</ul>

<aside class="notes">
<p>
I use this <b>ALL</b>. <b>THE</b>. <b>TIME</b>. If this class is to teach you 20% that
accomplishes 80%, <b>this slide</b> is the 5% that accomplishes 95%.
</p>

</aside>

</section>
<section id="slide-orgf029741">
<h3 id="orgf029741">Class Expressions</h3>
<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">commands</span>:
  <span style="color: #fb4933;">apache_config_repaired.debian</span>::
    <span style="color: #b8bb26;">"/usr/sbin/apache2ctl graceful"</span>;
  <span style="color: #fb4933;">apache_config_reparied.redhat</span>::
    <span style="color: #b8bb26;">"/usr/sbin/apachectl graceful"</span>;
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Operator</th>
<th scope="col" class="org-left">Meaning</th>
<th scope="col" class="org-left">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>.</code> and <code>&amp;</code></td>
<td class="org-left">boolean <b>and</b></td>
<td class="org-left"><code>debian.Tuesday::</code></td>
</tr>

<tr>
<td class="org-left"><code></code> and <code></code></td>
<td class="org-left">boolean <b>or</b></td>
<td class="org-left"><code>TuesdayWednesday::</code></td>
</tr>

<tr>
<td class="org-left"><code>!</code></td>
<td class="org-left">boolean <b>not</b></td>
<td class="org-left"><code>!Monday::</code></td>
</tr>

<tr>
<td class="org-left"><code>( )</code></td>
<td class="org-left">Explicit grouping</td>
<td class="org-left"><code>(debianredhat).!ubuntu.!centos::</code></td>
</tr>
</tbody>
</table>

</section>
<section id="slide-orgb47ff87">
<h3 id="orgb47ff87">Variable class expressions</h3>
<p>
Since 3.7.0 CFEngine is able to dereference variables directly within class
expressions. Note that quotes surrounding the entire expression ending before
the <code>::</code> are required.
</p>

<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">vars</span>:
    <span style="color: #b8bb26;">"variable_containing_class"</span> <span style="color: #d3869b;">string</span> =&gt; <span style="color: #b8bb26;">"cfengine"</span>;

  <span style="color: #fe8019;">reports</span>:
    <span style="color: #b8bb26;">"$(variable_containing_class)"</span>::
      <span style="color: #b8bb26;">"'$(variable_containing_class)' is defined"</span>;

    <span style="color: #b8bb26;">"!$(variable_containing_class)"</span>::
      <span style="color: #b8bb26;">"'$(variable_containing_class)' is NOT defined"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<pre class="example">
# cf-agent --no-lock --file ./examples/example_variable_class_expressions.cf
R: 'cfengine' is defined
</pre>

</section>
<section id="slide-org73d41b6">
<h3 id="org73d41b6">A Note About Classes and Distributions Based on Other Distributions</h3>
<p>
I said that only Debian systems will run <code>debian::</code> and only Red Hat will run
<code>redhat::</code>. This isn't exactly true.
</p>

<ul>
<li>Ubuntu is based on Debian, and so will have both <code>ubuntu</code> and <code>debian</code> defined
as hard classes.</li>
<li>Likewise, CentOS is based on Red Hat and so will have both <code>centos</code> and
<code>redhat</code> defined as hard classes.</li>
<li>MPF defines <code>redat_pure</code> and <code>debian_pure</code>.</li>

</ul>

</section>
</section>
<section>
<section id="slide-org6beee4f">
<h2 id="org6beee4f">Augments (<code>def.json</code>)</h2>
<ul>
<li>Very early definition</li>
<li>Loaded if <code>def.json</code> is found next to policy entry</li>
<li>Classes based on system discovery (platform/networks/arch)</li>
<li>Variables defined in <code>def</code> bundle scope</li>

</ul>

</section>
<section id="slide-orgfb51ddb">
<h3 id="orgfb51ddb">Example augments</h3>
<ul>
<li>Define <code>supported_platform</code> if the class <code>ubuntu_14</code>, <code>ubuntu_16</code>, or
<code>ubuntu_17</code> is defined.</li>
<li>Define <code>by_hostname</code> if the class <code>nickanderson_thinkpad_w550s</code> is defined.</li>

</ul>

<div class="org-src-container">
<label class="org-src-name">examples/augments/def.json</label>
<pre  class="src src-json"><span style="color: #458588;">{</span>
  <span style="color: #fb4933;">"classes"</span>: <span style="color: #b16286;">{</span>
      <span style="color: #fb4933;">"supported_platform"</span>: <span style="color: #8ec07c;">[</span> <span style="color: #b8bb26;">"ubuntu_\\d+"</span> <span style="color: #8ec07c;">]</span>,
      <span style="color: #fb4933;">"by_hostname"</span>: <span style="color: #8ec07c;">[</span> <span style="color: #b8bb26;">"nickanderson_thinkpad_w550s"</span> <span style="color: #8ec07c;">]</span>
  <span style="color: #b16286;">}</span>,
  <span style="color: #fb4933;">"vars"</span>: <span style="color: #b16286;">{</span>
      <span style="color: #fb4933;">"myvar1"</span>: <span style="color: #b8bb26;">"defined from augments"</span>,
      <span style="color: #fb4933;">"myvar2"</span>: <span style="color: #b8bb26;">"defined from augments"</span>
    <span style="color: #b16286;">}</span>
<span style="color: #458588;">}</span>
</pre>
</div>

</section>
<section id="slide-org795d5d9">
<h3 id="org795d5d9">Example policy using augments</h3>
<div class="org-src-container">
<label class="org-src-name">examples/augments/augments.cf</label>
<pre  class="src src-cfengine3" id="examples/augments/augments.cf"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">reports</span>:
    <span style="color: #b8bb26;">"I defined '$(const.dollar)(def.myvar1)' as '$(def.myvar1)'"</span>;

    <span style="color: #fb4933;">supported_platform</span>::
      <span style="color: #b8bb26;">"This is a supported platform"</span>;

    <span style="color: #fb4933;">by_hostname</span>::
      <span style="color: #b8bb26;">"You can define classes from augments based on defined hostname"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

</section>
<section id="slide-org2dd56f6">
<h3 id="org2dd56f6">Example output</h3>
<div class="org-src-container">

<pre  class="src src-sh">cf-agent --no-lock --file ./examples/augments/augments.cf
</pre>
</div>

<pre class="example">
R: I defined '$(def.myvar1)' as 'defined from augments'
R: This is a supported platform
R: You can define classes from augments based on defined hostname
</pre>

</section>
<section id="slide-orgc44bf0b">
<h3 id="orgc44bf0b">Policy always wins!</h3>
<div class="org-src-container">
<label class="org-src-name">examples/augments/augments-policy-wins.cf</label>
<pre  class="src src-cfengine3" id="examples/augments/augments-policy-wins.cf"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">common</span> <span style="color: #fabd2f;">def</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">vars</span>:
    <span style="color: #b8bb26;">"myvar1"</span> <span style="color: #d3869b;">string</span> =&gt; <span style="color: #b8bb26;">"Defined in policy"</span>;
    <span style="color: #b8bb26;">"myvar2"</span> <span style="color: #d3869b;">string</span> =&gt; <span style="color: #b8bb26;">"Defined in policy"</span>, if =&gt; not<span style="color: #b16286;">(</span> isvariable<span style="color: #8ec07c;">(</span> myvar2 <span style="color: #8ec07c;">)</span> <span style="color: #b16286;">)</span>;
<span style="color: #458588;">}</span> 
<span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">reports</span>:
    <span style="color: #b8bb26;">"I defined '$(const.dollar)(def.myvar1)' as '$(def.myvar1)'"</span>;
    <span style="color: #b8bb26;">"I defined '$(const.dollar)(def.myvar2)' as '$(def.myvar2)'"</span>;

    <span style="color: #fb4933;">supported_platform</span>::
      <span style="color: #b8bb26;">"This is a supported platform"</span>;

    <span style="color: #fb4933;">by_hostname</span>::
      <span style="color: #b8bb26;">"You can define classes from augments based on defined hostname"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

</section>
<section id="slide-orgd978c15">
<h3 id="orgd978c15">Example output</h3>
<div class="org-src-container">

<pre  class="src src-sh">cf-agent --no-lock --file ./examples/augments/augments-policy-wins.cf
</pre>
</div>

<pre class="example">
R: I defined '$(def.myvar1)' as 'Defined in policy'
R: I defined '$(def.myvar2)' as 'defined from augments'
R: This is a supported platform
R: You can define classes from augments based on defined hostname
</pre>

</section>
<section id="slide-org58ee352">
<h3 id="org58ee352">Multiple augments</h3>
<p>
Merge more specific augments (based on sys vars) on top.
</p>

<div class="org-src-container">
<label class="org-src-name">examples/augments-multiple/def.json</label>
<pre  class="src src-json"><span style="color: #458588;">{</span>
  <span style="color: #fb4933;">"vars"</span>: <span style="color: #b16286;">{</span>
      <span style="color: #fb4933;">"myvar1"</span>: <span style="color: #b8bb26;">"defined from augments for all"</span>,
      <span style="color: #fb4933;">"myvar2"</span>: <span style="color: #b8bb26;">"defined from augments for all"</span>
    <span style="color: #b16286;">}</span>,
  <span style="color: #fb4933;">"augments"</span>: <span style="color: #b16286;">[</span> <span style="color: #b8bb26;">"$(sys.policy_entry_dirname)/$(sys.os).json"</span> <span style="color: #b16286;">]</span>
<span style="color: #458588;">}</span>
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name">examples/augments-multiple/linux.json</label>
<pre  class="src src-json"><span style="color: #458588;">{</span>
  <span style="color: #fb4933;">"vars"</span>: <span style="color: #b16286;">{</span>
      <span style="color: #fb4933;">"myvar2"</span>: <span style="color: #b8bb26;">"override for linux hosts"</span>
    <span style="color: #b16286;">}</span>
<span style="color: #458588;">}</span>
</pre>
</div>

</section>
<section id="slide-orge165121">
<h4 id="orge165121">Multiple augments: Example policy</h4>
<div class="org-src-container">
<label class="org-src-name">examples/augments-multiple/promises.cf</label>
<pre  class="src src-cfengine3" id="examples/augments-multiple/promises.cf"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">reports</span>:
    <span style="color: #b8bb26;">"'$(const.dollar)(def.myvar1)' is '$(def.myvar1)'"</span>;
    <span style="color: #b8bb26;">"'$(const.dollar)(def.myvar2)' is '$(def.myvar2)'"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<div class="org-src-container">

<pre  class="src src-sh">cf-agent --no-lock --file ./examples/augments-multiple/promises.cf
</pre>
</div>

<pre class="example">
R: '$(def.myvar1)' is 'defined from augments for all'
R: '$(def.myvar2)' is 'override for linux hosts'
</pre>


</section>
</section>
<section>
<section id="slide-orgd7fe5cb">
<h2 id="orgd7fe5cb">Managing Processes</h2>
</section>
<section id="slide-org1f0707a">
<h3 id="org1f0707a">Keep Services Running: Using Processes</h3>
<div class="org-src-container">

<pre  class="src src-cfengine3" id="./examples/example_apache_service_running.cf"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">apache</span> <span style="color: #458588;">{</span>

  <span style="color: #fe8019;">processes</span>:
      <span style="color: #b8bb26;">".*apache2.*"</span>
        restart_class =&gt; <span style="color: #b8bb26;">"apache2_not_running"</span>;

  <span style="color: #fe8019;">commands</span>:
    <span style="color: #fb4933;">apache2_not_running</span>::
      <span style="color: #b8bb26;">"/etc/init.d/apache2 start"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<aside class="notes">
<p>
This policy uses a <code>processes</code> promise to check the process table (with <code>ps</code>)
for the regular expression <code>.*apache2.*</code>. If it is not found then the class
<code>apache2_not_running</code> will get defined.
</p>

<p>
When CFEngine executes <code>commands</code> promises Apache will be started.
</p>

</aside>

</section>
<section id="slide-orgbd83952">
<h3 id="orgbd83952">Ensuring Processes are Not Running: Using Processes and Commands</h3>
<div class="org-src-container">
<label class="org-src-name">examples/process_stop_bluetoothd.cf</label>
<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">stop_bluetooth</span> <span style="color: #458588;">{</span>

  <span style="color: #fe8019;">processes</span>:

    <span style="color: #b8bb26;">"bluetoothd"</span>
      process_stop =&gt; <span style="color: #b8bb26;">"/etc/init.d/bluetooth stop"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<p>
This policy uses a <code>processes</code> promise to check the process table (with <code>ps</code>)
for the regular expression <code>.*bluetoothd.*</code>. If it is found the <code>process_stop</code>
command is executed.
</p>

</section>
<section id="slide-org2d75d32">
<h3 id="org2d75d32">Ensuring Processes are Not Running: Using Processes and Signals</h3>
<div class="org-src-container">
<label class="org-src-name">examples/process_signals_bluetoothd.cf</label>
<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">stop_bluetooth</span> <span style="color: #458588;">{</span>

  <span style="color: #fe8019;">processes</span>:

    <span style="color: #b8bb26;">".*bluetoothd.*"</span>
      signals =&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"term"</span>, <span style="color: #b8bb26;">"kill"</span> <span style="color: #b16286;">}</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<p>
This policy uses a <code>processes</code> promise to check the process table (with <code>ps</code>)
for the regular expression <code>.*bluetoothd.*</code>. Any matching process is sent the
<code>term</code> signal, then sent the <code>kill</code> signal.
</p>

<aside class="notes">
<p>
<b>Note:</b> The promise <code>bluetoothd</code> becomes the <b>regular expression</b>,
<code>.*bluetoothd.*</code> that is matched against the output of <code>ps</code>. This means that it
can match <b>anywhere</b> on the line (in versions prior to 3.9), not just the
process name field. <b>Caveat emptor!</b>
</p>

</aside>

</section>
<section id="slide-orgb42acf9">
<h3 id="orgb42acf9">Keep Services Running: Using Services</h3>
<div class="org-src-container">

<pre  class="src src-cfengine3" id="examples/example_service_running.cf"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">apache</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">services</span>:

    <span style="color: #b8bb26;">"www"</span>
      service_policy =&gt; <span style="color: #b8bb26;">"start"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<p>
This uses the <code>services</code> promise type to ensure that Apache is always running.
</p>

<p>
The <code>standard_services</code> bundle implementation currently covers <code>systemd</code>,
<code>chkconfig</code>, the <code>service</code> command, <code>svcadm</code> and <code>systemV</code> init scripts. Proper
functionality relies on each installed service correctly implementing a service
check as appropriate for the init system in use.
</p>

</section>
<section id="slide-orgab2b500">
<h3 id="orgab2b500">Ensuring Processes are Not Running: Using Services</h3>
<div class="org-src-container">
<label class="org-src-name">examples/services_bluetoothd_stop.cf</label>
<pre  class="src src-cfengine3" id="examples/services_bluetoothd_stop.cf"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">stop_bluetoothd</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">services</span>:

    <span style="color: #b8bb26;">"bluetoothd"</span>
      service_policy =&gt; <span style="color: #b8bb26;">"stop"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<p>
This policy uses a <code>services</code> promise type to ensure that Bluetooth services are
not running. Again, this only works for services that are defined under
<code>standard_services</code> in the standard library and requires cfengine 3.4.0 or
higher.
</p>

<p>
The same restrictions about distros apply to stopping services promises.
</p>

</section>
<section id="slide-org062091e">
<h3 id="org062091e">A note on the services promise abstraction</h3>
<p>
Services promises are really an <a href="https://cmdln.org/2019/05/31/custom-services-in-cfengine-3/">abstraction on bundles</a>.
</p>

</section>
</section>
<section>
<section id="slide-orgc3ef2d0">
<h2 id="orgc3ef2d0">Managing Packages</h2>
</section>
<section id="slide-org99f3c47">
<h3 id="org99f3c47">Package modules (newer implementation)</h3>
<p>
<code>apt_get</code>, <code>pkgsrc</code>, <code>freebsd_ports</code>, <code>slackpkg</code>, <code>msiexec</code>, <code>yum</code>, <code>nimclient</code>,
 <code>zypper</code>, <code>pkg</code>
</p>

</section>
<section id="slide-org3560840">
<h4 id="org3560840">Example use of package_module</h4>
<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">install</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">packages</span>:
    <span style="color: #b8bb26;">"zsh"</span>
      policy  =&gt; <span style="color: #b8bb26;">"present"</span>,
      package_module  =&gt; yum,
      version =&gt; <span style="color: #b8bb26;">"latest"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<ul>
<li>The <code>policy</code> of <code>present</code> will make sure the package is installed on the
system, while a <code>policy</code> of <code>absent</code> will ensure a package is not installed.</li>
<li>The <code>package_module</code> of <code>yum</code> is included in the Masterfiles Policy Framework.</li>
<li>The <code>version</code> of <code>latest</code> means the installed version should be the latest
available. Alternatively you can provide an explicit version.</li>

</ul>

</section>
<section id="slide-orgd900c55">
<h3 id="orgd900c55">Package modules (legacy implementation)</h3>
<p>
<code>alpinelinux</code>, <code>freebsd</code>, <code>opencsw</code>, <code>solaris_install</code>, <code>apt</code>,
<code>freebsd_portmaster</code>, <code>pacman</code>, <code>windows_feature</code>, <code>apt_get</code>, <code>generic</code>, <code>pip</code>,
<code>yum</code>, <code>apt_get_permissive</code>, <code>ips</code>, <code>rpm_filebased</code>, <code>yum_group</code>,
<code>apt_get_release</code>, <code>msi_explicit</code>, <code>rpm_version</code>, <code>yum_rpm</code>, <code>brew</code>,
<code>msi_implicit</code>, <code>smartos</code>, <code>yum_rpm_enable_repo</code>, <code>dpkg_version</code>, <code>npm</code>,
<code>smartos_pkg_add(repo)</code>, <code>yum_rpm_permissive</code>, <code>emerge</code>, <code>npm_g</code>, <code>solaris</code>,
<code>zypper</code>,
</p>

</section>
<section id="slide-orge6d7b7c">
<h4 id="orge6d7b7c">Example use of package_method</h4>
<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">install</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">packages</span>:
    <span style="color: #b8bb26;">"zsh"</span>
      package_policy  =&gt; <span style="color: #b8bb26;">"addupdate"</span>,
      package_method  =&gt; apt,
      package_select  =&gt; <span style="color: #b8bb26;">"&gt;=,</span>
<span style="color: #b8bb26;">      package_version =&gt; "</span><span style="color: #d3869b;">4</span>.<span style="color: #d3869b;">3</span>.<span style="color: #d3869b;">10-14</span><span style="color: #b8bb26;">";</span>
<span style="color: #b8bb26;">}</span>
</pre>
</div>

<ul>
<li>The <code>package_policy</code> of <code>addupdate</code> will install or upgrade. Using <code>add</code>
will only install, never upgrade, <code>upgrade</code> will upgrade only and <code>delete</code>
will uninstall.</li>
<li>The <code>package_method</code> of <code>apt</code> is in the standard library, look there for other
package methods (e.g., rpm, ips, etc.).</li>
<li>The <code>package_select</code> of <code>&gt;=</code> means the installed version must be equal to or
newer than the specified version or it will be replaced. Using <code>&lt;=</code> would
downgrade, if the <code>package_method</code> supports downgrading and <code>==</code> will
require the exact version.</li>

</ul>

<aside class="notes">
<p>
Packages promises have be re-vamped with a new implementation that makes it
easier to dig into the specific details of how packages should be managed.
</p>

</aside>

</section>
</section>
<section>
<section id="slide-org7c01125">
<h2 id="org7c01125">Managing Files</h2>
</section>
<section id="slide-orga91528b">
<h3 id="orga91528b">Methodologies</h3>
<ul>
<li>Full file management</li>
<li>Partial file management</li>

</ul>

</section>
<section id="slide-org12b658b">
<h3 id="org12b658b">Templating a file</h3>
<dl>
<dt><a href="http://mustache.github.io/">mustache</a></dt><dd>Logic-less templating engine (<b>preferred</b>)</dd>
<dt><a href="https://docs.cfengine.com/lts/reference-promise-types-files.html#edit_template">cfengine</a></dt><dd>CFEngine's original line based templating</dd>

</dl>

</section>
<section id="slide-org11c1452">
<h4 id="org11c1452">Mustache Templating</h4>
<div class="org-src-container">
<label class="org-src-name">examples/template.mustache</label>
<pre  class="src src-text">Hello from {{{vars.sys.fqhost}}}!

{{#classes.linux}}I am a Linux Box!{{/classes.linux}}
{{^classes.windows}}I am NOT a Windows Box{{/classes.windows}}
</pre>
</div>

<div class="org-src-container">
<label class="org-src-name">examples/template_file.cf</label>
<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span><span style="color: #458588;">{</span>
  <span style="color: #fe8019;">files</span>:
      <span style="color: #b8bb26;">"/tmp/example"</span>
        create =&gt; <span style="color: #b8bb26;">"true"</span>,
        edit_template =&gt; <span style="color: #b8bb26;">"$(this.promise_dirname)/template.mustache"</span>,
        template_method =&gt; <span style="color: #b8bb26;">"mustache"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

</section>
<section id="slide-org6703343">
<h4 id="org6703343">Mustache Extensions</h4>
<dl>
<dt><code>-top-</code></dt><dd>Special key representing the complete data given to the templating
engine.</dd>
<dt><code>@</code></dt><dd>Expands to the key that is currently iterating.</dd>
<dt><code>%</code></dt><dd>Variable prefix causing the data to be rendered as the multi-line JSON
representation of the data given to the templating engine.</dd>
<dt><code>$</code></dt><dd>Variable prefix causing the data to be rendered as the serialized JSON
representation of the data given to the templating engine.</dd>

</dl>

</section>
<section id="slide-org7b603ac">
<h4 id="org7b603ac">Example: Render multiline JSON for <code>packagesmatching()</code></h4>
<p>
<code>packagesmatching()</code> returns data. Render the multiline JSON representation of the data.
</p>

<div class="org-src-container">

<pre  class="src src-cfengine3" id="examples/render_multiline_json_for_packagesmatching.cf"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">vars</span>:
      <span style="color: #b8bb26;">"p"</span> <span style="color: #d3869b;">data</span> =&gt; packagesmatching<span style="color: #b16286;">(</span> <span style="color: #b8bb26;">"emacs.*"</span>, <span style="color: #b8bb26;">".*"</span>, <span style="color: #b8bb26;">".*"</span>, <span style="color: #b8bb26;">".*"</span><span style="color: #b16286;">)</span>;

      <span style="color: #b8bb26;">"r"</span> <span style="color: #d3869b;">string</span> =&gt; string_mustache<span style="color: #b16286;">(</span> <span style="color: #b8bb26;">"{{%-top-}}"</span>, p <span style="color: #b16286;">)</span>,
        if =&gt; not<span style="color: #b16286;">(</span>isvariable<span style="color: #8ec07c;">(</span> r <span style="color: #8ec07c;">)</span> <span style="color: #b16286;">)</span>;

  <span style="color: #fe8019;">reports</span>:
      <span style="color: #b8bb26;">"$(r)"</span>;

<span style="color: #458588;">}</span>
</pre>
</div>

</section>
<section id="slide-org146fd46">
<h4 id="org146fd46">Output: Render multiline JSON for <code>packagesmatching()</code></h4>
<pre class="example">
R: [
  {
    "arch": "default",
    "method": "dpkg",
    "name": "emacsen-common",
    "version": "2.0.8"
  },
  {
    "arch": "default",
    "method": "dpkg",
    "name": "emacs24-common-non-dfsg",
    "version": "24.4+1-2"
  },
  {
    "arch": "default",
    "method": "dpkg",
    "name": "emacs24-common",
    "version": "24.5+1-1ubuntu2"
  },
  {
    "arch": "default",
    "method": "dpkg",
    "name": "emacs24-bin-common",
    "version": "24.5+1-1ubuntu2"
  },
  {
    "arch": "default",
    "method": "dpkg",
    "name": "emacs24",
    "version": "24.5+1-1ubuntu2"
  },
  {
    "arch": "default",
    "method": "dpkg",
    "name": "emacs",
    "version": "46.1"
  }
]
</pre>

</section>
<section id="slide-orge261f42">
<h4 id="orge261f42">Mustache Tips</h4>
<ul>
<li>Render raw values with <code>{{{VAR}}}</code> or <code>{{&amp; VAR}}</code>. <b>Mustache html escapes by
default</b>.</li>

<li>Use <a href="https://docs.cfengine.com/lts/reference-functions-string_mustache.html">string_mustache()</a> to render mustache into a string.</li>

<li><a href="https://docs.cfengine.com/lts/reference-promise-types-files.html#template_data">template_data()</a> Helps to separate CFEngine specifics from templates.</li>

</ul>

<aside class="notes">
<ul>
<li>Watch out for html escaped values</li>
<li><code>template_method =&gt; "inline_mustache"</code> coming in future release</li>
<li>Separating cfengine specifics from templates can ease offloading templates
and data to external agents.</li>

</ul>

</aside>

</section>
<section id="slide-org84fbb9d">
<h3 id="org84fbb9d">Deleting a file</h3>
<div class="org-src-container">
<label class="org-src-name">examples/example_delete_old_log_files.cf</label>
<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">tidy</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">files</span>:
    <span style="color: #b8bb26;">"/var/log/.*"</span>
      file_select =&gt; days_old<span style="color: #b16286;">(</span><span style="color: #b8bb26;">"7"</span><span style="color: #b16286;">)</span>,
      delete =&gt; tidy;
<span style="color: #458588;">}</span>
</pre>
</div>

<p>
This policy will delete any files in <code>/var/log/</code> older than 7 days. The
<code>days_old()</code> and <code>tidy</code> bodies are included in the standard library,
</p>

<p>
To delete a file indiscriminately, omit the <code>file_select</code>.
</p>

<p>
Look up <a href="https://docs.cfengine.com/lts/reference-promise-types-files.html#file_select"><code>file_select</code></a> and <a href="https://docs.cfengine.com/lts/reference-masterfiles-policy-framework-lib-files.html#tidy"><code>tidy</code></a> in the <a href="https://docs.cfengine.com/lts/reference.html">reference-manual</a> to find more ways to
use this.
</p>

</section>
</section>
<section>
<section id="slide-org22cd150">
<h2 id="org22cd150">Troubleshooting</h2>
<div class="outline-text-2" id="text-org22cd150">
</div>
</section>
<section id="slide-org15c4153">
<h3 id="org15c4153">Which hub am I bootstrapped to?</h3>
<ul>
<li><code>cat /var/cfengine/policy_server.dat</code></li>
<li><code>cf-promises --show-vars | grep sys.policy_hub</code></li>

</ul>

</section>
<section id="slide-org99b4972">
<h3 id="org99b4972">Is cfengine running?</h3>
<ul>
<li><code>ps -ef | grep [c]f-</code></li>

</ul>

<p>
You should expect to find <code>cf-execd</code>, <code>cf-serverd</code>, and <code>cf-monitord</code> on all
hosts. Additional processes will be seen on Enterprise Hubs
</p>

</section>
<section id="slide-org867f54f">
<h3 id="org867f54f">When did the agent last run?</h3>
<ul>
<li><code>ls -lh /var/cfengine/promise_summary.log</code></li>

</ul>

</section>
<section id="slide-org83927e4">
<h3 id="org83927e4">Review output from previous agent runs</h3>
<ul>
<li><code>ls /var/cfengine/outputs</code></li>
<li><code>cat /var/cfengine/outputs/previous</code></li>

</ul>

</section>
<section id="slide-org1dee5f3">
<h3 id="org1dee5f3">Manual report collection from Enterprise Hub</h3>
<ul>
<li><code>cf-hub --hail &lt;IP|HOSTNAME&gt; --verbose --query rebase</code></li>
<li><code>cf-hub -H &lt;IP|HOSTNAME&gt; -v -q delta</code></li>

</ul>

</section>
<section id="slide-org8ef4d1a">
<h4 id="org8ef4d1a">Unspecified server refusal</h4>
<pre class="example">
[root@hub ~]# cf-hub -H 10.10.10.11 -q rebase
   error: Abort transmission: got " Unspecified server refusal (see verbose server output)" from 10.10.10.11
</pre>

<ul>
<li>Usually indicates the host does not trust the hub.</li>
<li>Is the host bootstrapped to the hub you expect?</li>
<li>Run cf-serverd on the client with <code>--verbose</code> and <code>--no-fork</code> to see why it's
refusing</li>

</ul>

</section>
<section id="slide-org7201dbf">
<h4 id="org7201dbf">Connection refused</h4>
<ul>
<li>Firewall blocking inbound connections on port <code>5308</code></li>
<li><code>cf-serverd</code> not running on remote host</li>

</ul>

</section>
</section>
<section>
<section id="slide-orgd17780f">
<h2 id="orgd17780f">Setting Up a Client/Server Environment</h2>
<p>
Before starting you need to have cfengine installed on the server and the client
and the server FQDN must be set properly in DNS (or use the IP addresses). This
is ideally handled by your provisioning process. Along with automating server
function you should also be automating your provisioning process.
</p>

<p>
Some ways of automating provisioning are <a href="http://fedoraproject.org">kickstart</a>, <a href="http://wiki.debian.org/DebianInstaller/Preseed">preseed</a>, <a href="http://wiki.debian.org/FAI">fai</a>, <a href="http://cobbler.github.io/">cobbler</a>, <a href="http://www.osalt.com/g4u">disk imaging</a>, <a href="http://aws.amazon.com/ec2/">instance cloning</a>, etc, etc. This, of course, is not a complete list.
</p>

</section>
<section id="slide-orgdd70480">
<h3 id="orgdd70480">Bootstraping the Server and Client</h3>
</section>
<section id="slide-org7b83b12">
<h4 id="org7b83b12">Server Side</h4>
<p>
Edit <code>/var/cfengine/masterfiles/def.cf</code> to set the <code>acl</code> list for the IP
addresses of your network, then run:
</p>

<pre class="example">
cf-agent --bootstrap $(hostname --fqdn)
cf-agent -KI
</pre>

</section>
<section id="slide-org1c454e8">
<h4 id="org1c454e8">Client Side</h4>
<p>
Simply run:
</p>

<pre class="example">
cf-agent --bootstrap server.fqdn.example.com
</pre>

<p>
You can use the server's IP address instead of the DNS name.
</p>

</section>
<section id="slide-org25ffaef">
<h3 id="org25ffaef">Managing and Distributing Policies</h3>
<p>
Policy is distributed from <code>/var/cfengine/masterfiles</code> on the server (also known as
the <code>policy_hub</code>) and are copied to <code>/var/cfengine/inputs</code>. All clients then
copy <code>/var/cfengine/inputs</code> from the server.
</p>

</section>
</section>
<section>
<section id="slide-orgc6feafc">
<h2 id="orgc6feafc">Reporting on Promise Outcomes</h2>
<p>
CFEngine logs to <code>/var/cfengine/promise_summary.log</code>. Here's an example log message:
</p>

<pre class="example">
1463018982,1463018990: Outcome of version CFEngine Promises.cf 3.7.0 (agent-0):\
 Promises observed - Total promise compliance: 93% kept, 3% repaired,\ 4% not kept (out of 148 events).\
 User promise compliance: 93% kept, 2% repaired, 5% not kept (out of 130 events).
 CFEngine system compliance: 94% kept, 6% repaired, 0% not kept (out of 18 events).
</pre>

<p>
<b>Note:</b> The timestamp is a Unix epoch.
</p>

<p>
CFEngine will also send an email to the configured address in <code>body executor
control=</code> any time there is output from an agent run that differed from the
previous run.
</p>

<p>
And finally you can use the <code>-I</code> flag to have CFEngine <b>inform</b> you of repairs.
(Shown here along with the <code>-K</code> flag which ignores any lock timers).
</p>

<pre class="example">
cf-agent -KI
</pre>

</section>
<section id="slide-orge3d9433">
<h4 id="orge3d9433">CFEngine Core/Community</h4>
<div class="outline-text-4" id="text-orge3d9433">
</div>
<ul class="org-ul">
<li><a id="org6e6c41c"></a>The verbose agent log<br />
<p>
Running the agent in verbose mode ( <code>cf-agent --verbose</code> | <code>cf-agent -v</code> )
provides all of the details about each promise and its result
</p>

<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>

  <span style="color: #fe8019;">files</span>:

      <span style="color: #b8bb26;">"/tmp/example"</span>
        handle =&gt; <span style="color: #b8bb26;">"example_file_exists_and_contains_date"</span>,
        create =&gt; <span style="color: #b8bb26;">"true"</span>,
        edit_line =&gt; lines_present<span style="color: #b16286;">(</span> $<span style="color: #8ec07c;">(</span><span style="color: #83a598;">sys.date</span><span style="color: #8ec07c;">)</span> <span style="color: #b16286;">)</span>;
<span style="color: #458588;">}</span>

<span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">edit_line</span> <span style="color: #fabd2f;">lines_present</span><span style="color: #458588;">(</span><span style="color: #83a598;">lines</span><span style="color: #458588;">)</span>
<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">@brief Ensure `lines` are present in the file. Lines that do not exist are appended to the file</span>
<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">@param List or string that should be present in the file</span>
<span style="color: #7c6f64;">#</span>
<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">**Example:**</span>
<span style="color: #7c6f64;">#</span>
<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">```cf3</span>
<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">bundle agent example</span>
<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">{</span>
<span style="color: #7c6f64;">#  </span><span style="color: #7c6f64;">vars:</span>
<span style="color: #7c6f64;">#    </span><span style="color: #7c6f64;">"nameservers" slist =&gt; { "8.8.8.8", "8.8.4.4" };</span>
<span style="color: #7c6f64;">#</span>
<span style="color: #7c6f64;">#  </span><span style="color: #7c6f64;">files:</span>
<span style="color: #7c6f64;">#      </span><span style="color: #7c6f64;">"/etc/resolv.conf" edit_line =&gt; lines_present( @(nameservers) );</span>
<span style="color: #7c6f64;">#      </span><span style="color: #7c6f64;">"/etc/ssh/sshd_config" edit_line =&gt; lines_present( "PermitRootLogin no" );</span>
<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">}</span>
<span style="color: #7c6f64;"># </span><span style="color: #7c6f64;">```</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">insert_lines</span>:

      <span style="color: #b8bb26;">"$(lines)"</span>
        comment =&gt; <span style="color: #b8bb26;">"Append lines if they don't exist"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<p>
In the verbose output as each promise is actuated a <code>BEGIN promsie</code> is emitted
with the promise handle or filename and line number position if it does not have
a handle. In the example output we can see that the promise for <code>/tmp/example</code>
was <code>REPAIRED</code>.
</p>

<pre class="example">
verbose: B: *****************************************************************
verbose: B: BEGIN bundle main
verbose: B: *****************************************************************
verbose: P: .........................................................
verbose: P: BEGIN promise 'example_file_exists_and_contains_date' of type "files" (pass 1)
verbose: P:    Promiser/affected object: '/tmp/example'
verbose: P:    Part of bundle: main
verbose: P:    Base context class: any
verbose: P:    Stack path: /default/main/files/'/tmp/example'[1]
verbose: Using literal pathtype for '/tmp/example'
verbose: No mode was set, choose plain file default 0600
   info: Created file '/tmp/example', mode 0600
verbose: Handling file edits in edit_line bundle 'lines_present'
verbose: V:     +  Private parameter: 'lines' in scope 'lines_present' (type: s) in pass 1
verbose: P: .........................................................
verbose: P: BEGIN promise 'promise_example_cf_32' of type "insert_lines" (pass 1)
verbose: P:    Promiser/affected object: 'Mon Dec  4 21:08:38 2017'
verbose: P:    Part of bundle: lines_present
verbose: P:    Base context class: any
verbose: P:    Stack path: /default/main/files/'/tmp/example'/default/lines_present/insert_lines/'Mon Dec  4 21:08:38 2017'[1]
verbose: P:
verbose: P:    Comment:  Append lines if they don't exist
verbose: Additional promise info: source path './example.cf' at line 32 comment 'Append lines if they don't exist'
verbose: Inserting the promised line 'Mon Dec  4 21:08:38 2017' into '/tmp/example' after locator
verbose: P: .........................................................
verbose: P: BEGIN promise 'promise_example_cf_32' of type "insert_lines" (pass 1)
verbose: P:    Promiser/affected object: 'Mon Dec  4 21:08:38 2017'
verbose: P:    Part of bundle: lines_present
verbose: P:    Base context class: any
verbose: P:    Stack path: /default/main/files/'/tmp/example'/default/lines_present/insert_lines/'Mon Dec  4 21:08:38 2017'[1]
verbose: P:
verbose: P:    Comment:  Append lines if they don't exist
verbose: P: .........................................................
verbose: P: BEGIN promise 'promise_example_cf_32' of type "insert_lines" (pass 1)
verbose: P:    Promiser/affected object: 'Mon Dec  4 21:08:38 2017'
verbose: P:    Part of bundle: lines_present
verbose: P:    Base context class: any
verbose: P:    Stack path: /default/main/files/'/tmp/example'/default/lines_present/insert_lines/'Mon Dec  4 21:08:38 2017'[1]
verbose: P:
verbose: P:    Comment:  Append lines if they don't exist
   info: Edit file '/tmp/example'
verbose: Handling file existence constraints on '/tmp/example'
verbose: A: Promise REPAIRED
verbose: P: END files promise (/tmp/example)
verbose: P: .........................................................
verbose: P: BEGIN promise 'example_file_exists_and_contains_date' of type "files" (pass 2)
verbose: P:    Promiser/affected object: '/tmp/example'
verbose: P:    Part of bundle: main
verbose: P:    Base context class: any
verbose: P:    Stack path: /default/main/files/'/tmp/example'[1]
verbose: Using literal pathtype for '/tmp/example'
verbose: P: .........................................................
verbose: P: BEGIN promise 'example_file_exists_and_contains_date' of type "files" (pass 3)
verbose: P:    Promiser/affected object: '/tmp/example'
verbose: P:    Part of bundle: main
verbose: P:    Base context class: any
verbose: P:    Stack path: /default/main/files/'/tmp/example'[1]
verbose: Using literal pathtype for '/tmp/example'
verbose: A: ...................................................
verbose: A: Bundle Accounting Summary for 'main' in namespace default
verbose: A: Promises kept in 'main' = 0
verbose: A: Promises not kept in 'main' = 0
verbose: A: Promises repaired in 'main' = 2
verbose: A: Aggregate compliance (promises kept/repaired) for bundle 'main' = 100.0%
verbose: A: ...................................................
verbose: B: *****************************************************************
verbose: B: END bundle main
verbose: B: *****************************************************************
verbose: Generate diff state reports for policy './example.cf' SKIPPED
verbose: No lock purging scheduled
verbose: Outcome of version (not specified) (agent-0): Promises observed - Total promise compliance: 0% kept, 100% repaired, 0% not kept (out of 2 events). User promise compliance: 0% kept, 100% repaired, 0% not kept (out of 2 events). CFEngine system compliance: 0% kept, 0% repaired, 0% not kept (out of 0 events).
</pre>
</li>

<li><a id="org0e3e130"></a>Promise logging<br />
<p>
Promises can be configured to <a href="https://docs.cfengine.com/lts/reference-promise-types.html#log_repaired">log their outcomes</a> to a file with <code>log_kept</code>,
<code>log_repaired</code>, and <code>log_failed</code> attributes in an action body.
</p>

<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">commands</span>:
      <span style="color: #b8bb26;">"/bin/true"</span>
        action =&gt; log_my_repairs<span style="color: #b16286;">(</span> <span style="color: #b8bb26;">'/tmp/repaired.log'</span> <span style="color: #b16286;">)</span>;

  <span style="color: #fe8019;">reports</span>:
      <span style="color: #b8bb26;">"/tmp/repaired.log"</span>
        printfile =&gt; cat<span style="color: #b16286;">(</span> $<span style="color: #8ec07c;">(</span><span style="color: #83a598;">this.promiser</span><span style="color: #8ec07c;">)</span> <span style="color: #b16286;">)</span>;
<span style="color: #458588;">}</span>

<span style="color: #fe8019;">body</span> <span style="color: #d3869b;">action</span> <span style="color: #fabd2f;">log_my_repairs</span><span style="color: #458588;">(</span><span style="color: #83a598;"> file </span><span style="color: #458588;">)</span>
<span style="color: #458588;">{</span>
      log_repaired =&gt; <span style="color: #b8bb26;">"$(file)"</span>;
      log_string =&gt; <span style="color: #b8bb26;">"$(sys.date) REPAIRED $(this.promiser)"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<pre class="example">
R: /tmp/repaired.log
R: Mon Dec  4 21:21:38 2017 REPAIRED /bin/true
</pre>
</li>
</ul>

</section>
<section id="slide-orgbdc75cb">
<h4 id="orgbdc75cb">CFEngine Enterprise</h4>
<p>
CFEngine enterprise provides details logging without special configuration.
</p>

<ul class="org-ul">
<li><a id="org164e8ad"></a>Changes UI<br />
<p>
The changes reporting interface is the easiest way to what repairs the agent is
making to your infrastructure.
</p>


<div class="figure">
<p><img src="./media/changes-ui.png" alt="changes-ui.png" />
</p>
</div>
</li>

<li><a id="org178574f"></a>Changes API<br />
<p>
Changes can also be queried from the <a href="https://docs.cfengine.com/lts/reference-enterprise-api-ref-changes.html">changes rest api</a>. Here we query for repairs made
by <code>files</code> type promises.
</p>
<pre class="example">
[root@hub ~]# curl https://hub/api/v2/changes/policy?promisetype=files
{
    "data": [
        {
            "bundlename": "cfe_internal_update_policy",
            "changetime": 1512427971,
            "hostkey": "SHA=01fe75e93ca88bbd381eb720e9b43d0840ea8727aae8fc84391c297c42798f5c",
            "hostname": "hub",
            "logmessages": [
                "Copying from 'localhost:/var/cfengine/masterfiles/cf_promises_release_id'"
            ],
            "policyfile": "/var/cfengine/inputs/cfe_internal/update/update_policy.cf",
            "promisees": [],
            "promisehandle": "cfe_internal_update_policy_files_inputs_dir",
            "promiser": "/var/cfengine/inputs",
            "promisetype": "files",
            "stackpath": "/default/cfe_internal_update_policy/files/'/var/cfengine/inputs'[1]"
        },
        {
            "bundlename": "cfe_internal_setup_knowledge",
            "changetime": 1512428912,
            "hostkey": "SHA=01fe75e93ca88bbd381eb720e9b43d0840ea8727aae8fc84391c297c42798f5c",
            "hostname": "hub",
            "logmessages": [
                "Owner of '/var/cfengine/httpd/htdocs/application/logs/./log-2017-12-04.log' was 0, setting to 497",
                "Group of '/var/cfengine/httpd/htdocs/application/logs/./log-2017-12-04.log' was 0, setting to 497",
                "Object '/var/cfengine/httpd/htdocs/application/logs/./log-2017-12-04.log' had permission 0644, changed it to 0640"
            ],
            "policyfile": "/var/cfengine/inputs/cfe_internal/enterprise/CFE_knowledge.cf",
            "promisees": [],
            "promisehandle": "cfe_internal_setup_knowledge_files_doc_root_application_logs",
            "promiser": "/var/cfengine/httpd/htdocs/application/logs/.",
            "promisetype": "files",
            "stackpath": "/default/cfe_internal_management/methods/'CFEngine_Internals'/default/cfe_internal_enterprise_main/methods/'hub'/default/cfe_internal_setup_knowledge/files/'/var/cfengine/httpd/htdocs/application/logs/.'[1]"
        }
    ],
    "total": 2,
    "next": null,
    "previous": null
}
</pre>

<p>
See Also: <a href="https://docs.cfengine.com/lts/examples-enterprise-api-examples-changes-api-usage.html">query rest api</a>
</p>
</li>

<li><a id="orge8d661b"></a>Custom Reports and Query API<br />
<p>
The custom reports interface and associated <a href="https://docs.cfengine.com/lts/reference-enterprise-api-ref-query.html">query rest api</a> allow more flexible
reports to be run.
</p>

<p>
Queries can be made against the <code>promiselog</code> table. This query finds the
promises that are repaired the most excluding internal cfengine related promises
and promises from the stdlib.
</p>

<div class="org-src-container">

<pre  class="src src-sql"><span style="color: #7c6f64;">-- Find most frequently repaired promises excluding lib and cfe_internal directories</span>
<span style="color: #fb4933;">SELECT</span> namespace,bundlename,promisetype,promisehandle, promiser, <span style="color: #fe8019;">count</span><span style="color: #458588;">(</span>promiseoutcome<span style="color: #458588;">)</span>
<span style="color: #fb4933;">AS</span> <span style="color: #fe8019;">count</span>
<span style="color: #fb4933;">FROM</span> promiselog
<span style="color: #fb4933;">WHERE</span> promiseoutcome = <span style="color: #b8bb26;">'REPAIRED'</span>
<span style="color: #fb4933;">AND</span> policyfile
<span style="color: #fb4933;">NOT</span> ilike <span style="color: #b8bb26;">'%/lib/%'</span>
<span style="color: #fb4933;">AND</span> policyfile
<span style="color: #fb4933;">NOT</span> ilike <span style="color: #b8bb26;">'%cfe_internal%'</span>
<span style="color: #fb4933;">GROUP</span> <span style="color: #fb4933;">BY</span> namespace, bundlename, promisetype,promisehandle,promiser
<span style="color: #fb4933;">ORDER</span> <span style="color: #fb4933;">BY</span> <span style="color: #fe8019;">count</span> <span style="color: #fb4933;">DESC</span>
</pre>
</div>

<p>
Reference: <a href="https://docs.cfengine.com/docs/3.10/examples-enterprise-api-examples-sql-queries.html">query api examples</a>
</p>
</li>

<li><a id="org8b824c0"></a>/var/cfengine/state/promise_log/*.csv<br />
<p>
<b>WARNING:</b> These logs are purged upon collection by the hub.
</p>

<p>
In Enterprise 3.7 each agent run logs to a CSV file named for the time the agent
started in <code>$(sys.workdir)/state/promise_log/</code>.
</p>

<p>
The fields are <code>promise hash</code>, <code>policy file</code>, <code>release id</code>, unknown (waiting on
developer feedback), <code>namespace</code>, <code>bundle</code>, <code>promise type</code>, <code>stack path</code> (call
tree), <code>promise handle</code>, <code>promisees</code>, <code>log messages</code>
</p>

<div class="org-src-container">

<pre  class="src src-text">719b756d3dc8fd7bdd20284c1fd894ae40bac55d8790855b074159db8fe187ae,/var/cfengine/inputs/cfe_internal/enterprise/CFE_hub_specific.cf,&lt;unknown-release-id&gt;,114,default,cfe_internal_update_folders,files,/var/cfengine/master_software_updates/windows_i686,/default/cfe_internal_management/methods/'CFEngine_Internals'/default/cfe_internal_enterprise_main/methods/'hub'/default/cfe_internal_update_folders/files/'/var/cfengine/master_software_updates/windows_i686'[40],cfe_internal_update_folders_files_create_dirs,"[""goal_updated""]","[""Created directory '/var/cfengine/master_software_updates/windows_i686/.'""]"
</pre>
</div>
</li>

<li><a id="orgef6bd88"></a>promise_log.jsonl<br />
<p>
<b>WARNING:</b> These logs are purged upon collection by the hub.
</p>

<p>
Beginning with Enterprise 3.9 we began logging promise outcomes to a JSON format
in <code>$(sys.statedir)/promise_log.jsonl</code>.
</p>

<p>
Each promise outcome is logged along with the bundle name, promise handle, log
messages near the promise actuation, the promise namespace, policy filename,
promise hash, promise type, promisees, promiser, release id, stack path (call
path), and the timestamp of the agent ran.
</p>

<p>
Here is an example of the output:
</p>

<div class="org-src-container">
<label class="org-src-name">promise_log.jsonl</label>
<pre  class="src src-json" id="promise_log.jsonl"><span style="color: #458588;">{</span>
    <span style="color: #fb4933;">"execution"</span>: <span style="color: #b16286;">{</span>
        <span style="color: #fb4933;">"bundle"</span>:<span style="color: #b8bb26;">"file_make_mustache"</span>,
        <span style="color: #fb4933;">"handle"</span>:<span style="color: #b8bb26;">""</span>,
        <span style="color: #fb4933;">"log_messages"</span>:<span style="color: #8ec07c;">[</span>
            "Created file '/var/cfengine/httpd/conf/httpd.conf.staged', mode <span style="color: #d3869b;">0600</span>",
            <span style="color: #b8bb26;">"Updated rendering of '/var/cfengine/httpd/conf/httpd.conf.staged' from mustache template '/var/cfengine/inputs/cfe_internal/enterprise/templates/httpd.conf.mustache'"</span>
        <span style="color: #8ec07c;">]</span>,
        <span style="color: #fb4933;">"namespace"</span>:<span style="color: #b8bb26;">"default"</span>,
        <span style="color: #fb4933;">"policy_filename"</span>:<span style="color: #b8bb26;">"/var/cfengine/inputs/lib/files.cf"</span>,
        <span style="color: #fb4933;">"promise_hash"</span>:<span style="color: #b8bb26;">"ebc3dce615bcdb724e53a9761a24f2e7ed4f2e01aed1ce85dc217a9d3429fed7"</span>,
        <span style="color: #fb4933;">"promise_outcome"</span>:<span style="color: #b8bb26;">"REPAIRED"</span>,
        <span style="color: #fb4933;">"promise_type"</span>:<span style="color: #b8bb26;">"files"</span>,
        <span style="color: #fb4933;">"promisees"</span>:<span style="color: #8ec07c;">[</span>
            <span style="color: #b8bb26;">"CFEngine Enterprise"</span>,
            <span style="color: #b8bb26;">"Mission Portal"</span><span style="color: #8ec07c;">]</span>,
        <span style="color: #fb4933;">"promiser"</span>:<span style="color: #b8bb26;">"/var/cfengine/httpd/conf/httpd.conf.staged"</span>,
        <span style="color: #fb4933;">"release_id"</span>:<span style="color: #b8bb26;">"&lt;unknown-release-id&gt;"</span>,
        <span style="color: #fb4933;">"stack_path"</span>:"/default/cfe_internal_management/methods/'CFEngine_Internals'/default/cfe_internal_enterprise_mission_portal/methods/'Apache Configuration'/default/cfe_internal_enterprise_mission_portal_apache/methods/'Stage Apache Config'/default/file_make_mustache/files/'/var/cfengine/httpd/conf/httpd.conf.staged'[<span style="color: #d3869b;">0</span>]"
    <span style="color: #b16286;">}</span>,
    <span style="color: #fb4933;">"timestamp"</span>:<span style="color: #d3869b;">1470326639</span>
<span style="color: #458588;">}</span>,
<span style="color: #458588;">{</span>
    <span style="color: #fb4933;">"execution"</span>:<span style="color: #b16286;">{</span>
        <span style="color: #fb4933;">"bundle"</span>:<span style="color: #b8bb26;">"mission_portal_apache_from_stage"</span>,
        <span style="color: #fb4933;">"handle"</span>:<span style="color: #b8bb26;">""</span>,
        <span style="color: #fb4933;">"log_messages"</span>:<span style="color: #8ec07c;">[</span>
            <span style="color: #b8bb26;">"Updated '/var/cfengine/httpd/conf/httpd.conf' from source '/var/cfengine/httpd/conf/httpd.conf.staged' on 'localhost'"</span>
        <span style="color: #8ec07c;">]</span>,
        <span style="color: #fb4933;">"namespace"</span>:<span style="color: #b8bb26;">"default"</span>,
        <span style="color: #fb4933;">"policy_filename"</span>:<span style="color: #b8bb26;">"/var/cfengine/inputs/cfe_internal/enterprise/mission_portal.cf"</span>,
        <span style="color: #fb4933;">"promise_hash"</span>:<span style="color: #b8bb26;">"d730f2911834395411e4f3168847fc6cc522955f97652de41e02c8bc15f3f761"</span>,
        <span style="color: #fb4933;">"promise_outcome"</span>:<span style="color: #b8bb26;">"REPAIRED"</span>,
        <span style="color: #fb4933;">"promise_type"</span>:<span style="color: #b8bb26;">"files"</span>,
        <span style="color: #fb4933;">"promisees"</span>:<span style="color: #8ec07c;">[</span>
            <span style="color: #b8bb26;">"CFEngine Enterprise"</span>,
            <span style="color: #b8bb26;">"Mission Portal"</span>
        <span style="color: #8ec07c;">]</span>,
        <span style="color: #fb4933;">"promiser"</span>:<span style="color: #b8bb26;">"/var/cfengine/httpd/conf/httpd.conf"</span>,
        <span style="color: #fb4933;">"release_id"</span>:<span style="color: #b8bb26;">"&lt;unknown-release-id&gt;"</span>,
        <span style="color: #fb4933;">"stack_path"</span>:"/default/cfe_internal_management/methods/'CFEngine_Internals'/default/cfe_internal_enterprise_mission_portal/methods/'Apache Configuration'/default/cfe_internal_enterprise_mission_portal_apache/methods/'Manage Final Apache Config'/default/mission_portal_apache_from_stage/files/'/var/cfengine/httpd/conf/httpd.conf'[<span style="color: #d3869b;">0</span>]"
    <span style="color: #b16286;">}</span>,
    <span style="color: #fb4933;">"timestamp"</span>:<span style="color: #d3869b;">1470326639</span>
<span style="color: #458588;">}</span>
</pre>
</div>
</li>
</ul>

</section>
<section id="slide-org09bb702">
<h3 id="org09bb702">Debugging</h3>
<p>
Inevitably, something will go wrong, and you will need to dig deep to figure
something out. Lucky for you, I have some tips for debugging.
</p>

</section>
<section id="slide-orgf182ed2">
<h4 id="orgf182ed2">Run without locks</h4>
<p>
Again, using <code>-K</code> to disable locks is useful.
</p>

</section>
<section id="slide-org6d11831">
<h4 id="org6d11831">Using Verbose Mode</h4>
<p>
CFEngine's verbose output can be fantastic for debugging. Use the <code>-v</code> flag to
turn it on.
</p>

<div class="org-src-container">

<pre  class="src src-sh">cf-agent -Kv | grep -A <span style="color: #d3869b;">5</span> <span style="color: #b8bb26;">"BEGIN bundle"</span>
</pre>
</div>

<p>
When viewing <code>verbose</code> output, look for <code>BUNDLE &lt;name&gt;</code> for the bundle that you
suspect is having trouble.
</p>

<pre class="example">
verbose: B: BEGIN bundle main
verbose: B: *****************************************************************
verbose: P: .........................................................
verbose: P: BEGIN promise 'promise_promises_cf_4' of type "reports" (pass 1)
verbose: P:    Promiser/affected object: 'Hello World!'
verbose: P:    Part of bundle: main
</pre>

<p>
CFEngine will tell you exactly what is going on with each promise, in
excruciating detail.
</p>

<pre class="example">
verbose: Using literal pathtype for '/tmp/touch'
verbose: No mode was set, choose plain file default 0600
   info: Created file '/tmp/touch', mode 0600
verbose: Handling file existence constraints on '/tmp/touch'
verbose: A: Promise REPAIRED
verbose: P: END files promise (/tmp/touch...)
</pre>

</section>
<section id="slide-orgf43c6a4">
<h4 id="orgf43c6a4">Comments</h4>
<p>
CFEngine supports <i>comments</i> as part of its data structure. Every promise can
have a <code>comment</code> attribute whose value is a quoted text string.
</p>

<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">example</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">files</span>:
    <span style="color: #b8bb26;">"/etc/bind/named.cache"</span>
      copy_from =&gt; scp<span style="color: #b16286;">(</span><span style="color: #b8bb26;">"$(def.files)/bind/named.cache"</span><span style="color: #b16286;">)</span>,
      comment   =&gt; <span style="color: #b8bb26;">"More recent copy of named.cache than shipped with bind"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<p>
Comments show up in the verbose output.
</p>

<pre class="example">
verbose: P:    Container path : '/default/main/files/'/etc/bind/named.cache'[0]'
verbose: P:
verbose: P:    Comment:  More recent copy of named.cache than shipped with bind.
verbose: P: .........................................................
</pre>

<p>
The comment should always be <b>why</b> the promise is being made. Up until now none
of the examples have used comments to save space on the slide. When writing your
policies for real <b>every</b> promise should have a meaningful comment.
</p>

<p>
You'll thank me when this saves the day.
</p>

<aside class="notes">
<p>
Think about why this promise is important to the proper functioning of your infrastructure.
</p>
<ul>
<li>What could go wrong if this promise isn't kept</li>

</ul>

</aside>

</section>
<section id="slide-org285176c">
<h4 id="org285176c">Promise Handles</h4>
<p>
When debugging, promise <i>handles</i> are also useful. Again, every promise can have
a <code>handle</code> attribute whose value is a quoted canonical string.
</p>

<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">example</span><span style="color: #458588;">{</span>
  <span style="color: #fe8019;">files</span>:
    <span style="color: #b8bb26;">"/etc/bind/named.cache"</span>
      copy_from =&gt; scp<span style="color: #b16286;">(</span><span style="color: #b8bb26;">"$(def.files)/bind/named.cache"</span><span style="color: #b16286;">)</span>,
      handle    =&gt; <span style="color: #b8bb26;">"update_etc_bind_named_cache"</span>,
      comment   =&gt; <span style="color: #b8bb26;">"More recent copy of named.cache than shipped with bind"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<p>
CFEngine will tell you the handle of each promise in the verbose output.
</p>

<pre class="example">
verbose: P: BEGIN promise 'update_etc_bind_named_cache' of type "files" (pass 1)
verbose: P:    Promiser/affected object: '/etc/bind/named.cache'
verbose: P:    Part of bundle: example
verbose: P:    Base context class: any
</pre>

<p>
By giving each promise a unique handle you can swiftly jump back and forth
between your debug output and your policy file. When writing your policies for
real <b>every</b> promise should have a unique handle.
</p>

<p>
You'll thank me when this saves the day.
</p>

<aside class="notes">
<p>

</p>

<p>
CFEngine Enterprise will automatically assign handles to each promise in the
form
<code>promise_$(this.promise_dirname)/$(this.promise_filename)_$(promise.line_number)</code>.
</p>

<p>
I believe this will come into core in 3.9 or 3.10.
@jimis?
</p>

</aside>

</section>
<section id="slide-org51be668">
<h4 id="org51be668">Promisees</h4>
<p>
When debugging, promise <i>stakeholders</i> aka <i>promisees</i> are useful for
understanding <a href="https://github.com/nickanderson/cfengine-inventory_users_last_login/commit/cd2fb3454cf362efa5621e39800984c1d7ad655e">who cares</a> about a given promise.
</p>

<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">example</span> <span style="color: #458588;">{</span>
  <span style="color: #fe8019;">files</span>:
    <span style="color: #b8bb26;">"/etc/bind/named.cache"</span> -&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"Operations"</span>, <span style="color: #b8bb26;">"Nick Anderson"</span> <span style="color: #b16286;">}</span>
      copy_from =&gt; scp<span style="color: #b16286;">(</span><span style="color: #b8bb26;">"$(def.files)/bind/named.cache"</span><span style="color: #b16286;">)</span>,
      handle    =&gt; <span style="color: #b8bb26;">"update_etc_bind_named_cache"</span>,
      comment   =&gt; <span style="color: #b8bb26;">"More recent copy of named.cache than shipped with bind"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<p>
CFEngine will tell you additional info about each promise.
</p>

<pre class="example">
verbose: Additional promise info: handle 'update_etc_bind_named_cache'\
         source path './t.cf' at line 4 promisee  {'Operations','Nick Anderson'}\
         comment 'More recent copy of named.cache than shipped with bind.'
</pre>

</section>
<section id="slide-org2fa5083">
<h4 id="org2fa5083">Meta</h4>
<p>
When debugging variables and classes promise <i>meta</i> data is useful to help
identify variables and classes with specific attributes.
</p>

<div class="org-src-container">
<label class="org-src-name"><code>debugging_classes_and_vars_with_tags.cf</code></label>
<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span><span style="color: #458588;">{</span>
  <span style="color: #fe8019;">classes</span>:
      <span style="color: #b8bb26;">"my_class"</span> expression =&gt; <span style="color: #b8bb26;">"any"</span>, meta =&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"mytag"</span> <span style="color: #b16286;">}</span>;
  <span style="color: #fe8019;">vars</span>:
      <span style="color: #b8bb26;">"my_var"</span> <span style="color: #d3869b;">string</span> =&gt; <span style="color: #b8bb26;">"value"</span>, meta =&gt; <span style="color: #b16286;">{</span> <span style="color: #b8bb26;">"mytag"</span> <span style="color: #b16286;">}</span>;
      <span style="color: #b8bb26;">"my_vars"</span> <span style="color: #d3869b;">slist</span> =&gt; variablesmatching<span style="color: #b16286;">(</span><span style="color: #b8bb26;">".*"</span>, <span style="color: #b8bb26;">"mytag"</span> <span style="color: #b16286;">)</span>;
      <span style="color: #b8bb26;">"my_classes"</span> <span style="color: #d3869b;">slist</span> =&gt; classesmatching<span style="color: #b16286;">(</span><span style="color: #b8bb26;">".*"</span>, <span style="color: #b8bb26;">"mytag"</span> <span style="color: #b16286;">)</span>;
  <span style="color: #fe8019;">reports</span>:
      <span style="color: #b8bb26;">"My var: $(my_vars)"</span>;
      <span style="color: #b8bb26;">"My class: $(my_classes)"</span>;
<span style="color: #458588;">}</span>
</pre>
</div>

<p>
<b>Note:</b> Promise meta data is not currently displayed in the CFEngine's verbose
output.
</p>

</section>
</section>
<section>
<section id="slide-org494787a">
<h2 id="org494787a">The Rest</h2>
<p>
Here's a list of topics that I didn't cover. This is to give you a taste of the
rest of the power that is behind CFEngine. Dig deeper by checking them out in
the <a href="https://docs.cfengine.com/lts/reference.html">reference manual</a>.
</p>

<ul>
<li><code>vars:</code> promises  Varables, strings, integers and reals (and lists of each).</li>
<li><code>methods:</code> promises  Create a self-contained bundle that can be called like a
function.</li>
<li><code>storage:</code> promises  For local or remote (NFS) filesystems.</li>
<li><code>edit_xml:</code> promises - Promise by path, CFEngine does the XML for you.</li>
<li>Monitoring  Using data from <code>cf-monitord</code>.</li>

</ul>

</section>
<section id="slide-orgfd98ae5">
<h3 id="orgfd98ae5">Pro Tips</h3>
<ul>
<li><i>Don't edit the standard library</i>. Create a <code>site_lib.cf</code> and add your custom
library bundles and bodies there. This helps with upgrading because you won't
have to patch your changes into the new version of the library. When you feel
a bundle or body is ready for public use you can submit it to CFEngine by
opening a pull request on <a href="http://github.com/cfengine/masterfiles">Github</a>.</li>
<li><i>Make built-in classes and user defined classes easy to distinguish by sight.</i>
CFEngine creates hard classes <code>all_lower_case_separated_by_underscores</code>.
Whenever I define classes myself I use <code>CamelCase</code>.</li>
<li><i>Not sure how to organize <code>masterfiles</code>?</i>
<ul>
<li><a href="https://digitalelf.net/2013/04/a-case-study-in-cfengine-layout/">A Case Study in CFEngine Layout</a> by Brian Bennett.</li>
<li><a href="https://github.com/nickanderson/example-a10042">Example a10042</a></li>

</ul></li>
<li><i>Use <code>git</code></i> to revision control <code>masterfiles</code>.</li>
<li><i>Syntax errors?</i> Only read the very first error. Fix it, then try again. A
missing character in one promise will throw the whole file off.</li>
<li>Checkout the <a href="https://docs.cfengine.com/lts/guide-language-concepts-augments.html">Augments file</a></li>
<li>Checkout <a href="https://stedolan.github.io/jq/">jq</a> (because you can use it with <a href="https://docs.cfengine.com/docs/3.9/reference-functions-mapdata.html">mapdata()</a> in 3.9+)</li>
<li>Read the <a href="https://docs.cfengine.com/lts/reference.html">reference manual</a> (all of it)</li>

</ul>

</section>
<section id="slide-orge79de7a">
<h4 id="orge79de7a">Magic in CFEngine</h4>
<ul class="org-ul">
<li><a id="org9d75176"></a>If I try to define a class with an illegal class character there is no error<br />
<p>
For example:
</p>

<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">classes</span>:

    <span style="color: #b8bb26;">"my-illegal-class"</span>;

  <span style="color: #fe8019;">reports</span>:
    <span style="color: #b8bb26;">"$(with)"</span> with =&gt; join<span style="color: #b16286;">(</span> <span style="color: #b8bb26;">" "</span>, classesmatching<span style="color: #8ec07c;">(</span> <span style="color: #b8bb26;">"my.illegal.class"</span> <span style="color: #8ec07c;">)</span> <span style="color: #b16286;">)</span>;

<span style="color: #458588;">}</span>
</pre>
</div>

<pre class="example">
R: my_illegal_class
</pre>


<p>
The agent assumes you intended to canonify the string in the spirit of auto
correction it canonifies it for you.
</p>

<p>
This courtesy is not extended when checking classes. You must explicitly
canonify your string when using it in a class expression.
</p>

<p>
For example: 
</p>

<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">vars</span>:

    <span style="color: #b8bb26;">"hostname"</span> <span style="color: #d3869b;">string</span> =&gt; <span style="color: #b8bb26;">"$(sys.uqhost)"</span>;

  <span style="color: #fe8019;">reports</span>:

    <span style="color: #fb4933;">any</span>::

      <span style="color: #b8bb26;">"$(hostname) contains invalid class characters"</span>;
      <span style="color: #b8bb26;">"The class expression containing a nonvalid character is not a valid class expression"</span>;
      <span style="color: #b8bb26;">"The agent silently skips the section"</span>; 

    <span style="color: #b8bb26;">"$(hostname)"</span>::
      <span style="color: #b8bb26;">"hello"</span>;

    <span style="color: #fb4933;">any</span>::

      <span style="color: #b8bb26;">"See that explicit canonification works"</span>;
      <span style="color: #b8bb26;">"Hi"</span>
        if =&gt; canonify<span style="color: #b16286;">(</span> $<span style="color: #8ec07c;">(</span><span style="color: #83a598;">hostname</span><span style="color: #8ec07c;">)</span> <span style="color: #b16286;">)</span>;
<span style="color: #458588;">}</span>

</pre>
</div>

<pre class="example">
R: nickanderson-thinkpad-w550s contains invalid class characters
R: The class expression containing a nonvalid character is not a valid class expression
R: The agent silently skips the section
R: See that explicit canonification works
R: Hi
</pre>
</li>

<li><a id="org79c04ae"></a>When I promise a directory is 600 it gets set to 700<br />
<p>
For example: 
</p>

<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">files</span>:
    <span style="color: #b8bb26;">"/tmp/dir/."</span>
      create =&gt; <span style="color: #b8bb26;">"true"</span>,
      perms =&gt; m<span style="color: #b16286;">(</span><span style="color: #d3869b;">600</span><span style="color: #b16286;">)</span>;

 <span style="color: #fe8019;">vars</span>:
   <span style="color: #b8bb26;">"mode"</span> <span style="color: #d3869b;">string</span> =&gt; filestat<span style="color: #b16286;">(</span> <span style="color: #b8bb26;">"/tmp/dir"</span>, permoct <span style="color: #b16286;">)</span>;

   <span style="color: #fe8019;">reports</span>:
     <span style="color: #b8bb26;">"/tmp/dir mode is $(with)"</span> with =&gt; filestat<span style="color: #b16286;">(</span> <span style="color: #b8bb26;">"/tmp/dir"</span>, permoct <span style="color: #b16286;">)</span>;

<span style="color: #458588;">}</span>
</pre>
</div>

<pre class="example">
R: /tmp/dir mode is 700
</pre>


<p>
This is configurable behavior but by default if you promise a directory should
be readable (list the files within the directory) the agent assumes that you
also meant for it to be executable so that it can be entered and access the file
and directories inside.
</p>

<p>
To disable the feature set <a href="https://docs.cfengine.com/lts/reference-promise-types-files.html#rxdirs">rxdirs</a> to <code>false</code> in the <code>perms</code> body you are
using.
</p>

<p>
For example:
</p>

<div class="org-src-container">

<pre  class="src src-cfengine3"><span style="color: #fe8019;">bundle</span> <span style="color: #d3869b;">agent</span> <span style="color: #fabd2f;">main</span>
<span style="color: #458588;">{</span>
  <span style="color: #fe8019;">files</span>:
    <span style="color: #b8bb26;">"/tmp/dir/."</span>
      create =&gt; <span style="color: #b8bb26;">"true"</span>,
      perms =&gt; my_m_norxdir<span style="color: #b16286;">(</span><span style="color: #d3869b;">600</span><span style="color: #b16286;">)</span>;

 <span style="color: #fe8019;">vars</span>:
   <span style="color: #b8bb26;">"mode"</span> <span style="color: #d3869b;">string</span> =&gt; filestat<span style="color: #b16286;">(</span> <span style="color: #b8bb26;">"/tmp/dir"</span>, permoct <span style="color: #b16286;">)</span>;

   <span style="color: #fe8019;">reports</span>:
     <span style="color: #b8bb26;">"/tmp/dir mode is $(with)"</span> with =&gt; filestat<span style="color: #b16286;">(</span> <span style="color: #b8bb26;">"/tmp/dir"</span>, permoct <span style="color: #b16286;">)</span>;
<span style="color: #458588;">}</span>

<span style="color: #fe8019;">body</span> <span style="color: #d3869b;">perms</span> <span style="color: #fabd2f;">my_m_norxdir</span><span style="color: #458588;">(</span><span style="color: #83a598;">mode</span><span style="color: #458588;">)</span>
<span style="color: #458588;">{</span>
  rxdirs =&gt; <span style="color: #b8bb26;">"false"</span>;
  inherit_from =&gt; m<span style="color: #b16286;">(</span> $<span style="color: #8ec07c;">(</span><span style="color: #83a598;">mode</span><span style="color: #8ec07c;">)</span> <span style="color: #b16286;">)</span>; <span style="color: #7c6f64;"># body inheritance available since 3.8.0</span>
<span style="color: #458588;">}</span>
</pre>
</div>

<pre class="example">
R: /tmp/dir mode is 600
</pre>
</li>
</ul>

</section>
</section>
<section>
<section id="slide-orgb463c68">
<h2 id="orgb463c68">Thanks</h2>
</section>
</section>
</div>
</div>
<p> Created by Nick Anderson. </p>
<script src="./reveal.js/lib/js/head.min.js"></script>
<script src="./reveal.js/js/reveal.js"></script>
<script>
// Full list of configuration options available here:
// https://github.com/hakimel/reveal.js#configuration
Reveal.initialize({

controls: true,
progress: true,
history: false,
center: true,
slideNumber: 'c',
rollingLinks: true,
keyboard: true,
mouseWheel: false,
fragmentInURL: false,
hashOneBasedIndex: false,
pdfSeparateFragments: true,

overview: true,
width: 1200,
height: 800,
margin: 0.10,
minScale: 0.50,
maxScale: 2.50,

theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
transition: Reveal.getQueryHash().transition || 'fade', // see README of reveal.js for options
transitionSpeed: 'default',

// Optional libraries used to extend on reveal.js
dependencies: [
 { src: './reveal.js/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }]

});
</script>
</body>
</html>
